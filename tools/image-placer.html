<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ–¼ï¸ Preview Image Placer Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* === å…¨åŸŸé‡ç½® & è®Šæ•¸ === */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0f0f17;
            --surface: #1a1a2e;
            --surface2: #222240;
            --border: #2d2d50;
            --text: #e8e8f0;
            --text-dim: #8888aa;
            --accent: #7c5cff;
            --accent-glow: rgba(124,92,255,0.3);
            --success: #22c55e;
            --success-glow: rgba(34,197,94,0.2);
            --warning: #f59e0b;
            --danger: #ef4444;
            --radius: 12px;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* === é ‚éƒ¨å·¥å…·åˆ— === */
        .toolbar {
            position: sticky; top: 0; z-index: 100;
            background: rgba(15,15,23,0.95);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
        }
        .toolbar h1 {
            font-size: 18px; font-weight: 700;
            background: linear-gradient(135deg, #7c5cff, #a78bfa);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            white-space: nowrap;
        }
        .toolbar select {
            background: var(--surface2); color: var(--text);
            border: 1px solid var(--border); border-radius: 8px;
            padding: 8px 12px; font-size: 14px; font-family: inherit;
            cursor: pointer; min-width: 180px;
        }
        .toolbar select:focus { outline: none; border-color: var(--accent); }
        .toolbar .stats {
            margin-left: auto; font-size: 13px; color: var(--text-dim);
            display: flex; gap: 16px; align-items: center;
        }
        .toolbar .stats .done { color: var(--success); font-weight: 600; }
        .toolbar .stats .missing { color: var(--warning); font-weight: 600; }

        /* === é€²åº¦æ¢ === */
        .progress-bar-wrap {
            width: 100%; height: 6px; background: var(--surface2);
            border-radius: 3px; overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%; background: linear-gradient(90deg, var(--accent), var(--success));
            border-radius: 3px; transition: width 0.4s ease;
        }

        /* === ä¸»å€åŸŸ === */
        .main { display: flex; gap: 0; height: calc(100vh - 80px); }

        /* === å·¦å´é¸é …åˆ—è¡¨ === */
        .item-list {
            width: 340px; min-width: 300px;
            overflow-y: auto; background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 8px;
        }
        .item-list::-webkit-scrollbar { width: 6px; }
        .item-list::-webkit-scrollbar-track { background: transparent; }
        .item-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .search-box {
            position: sticky; top: 0; z-index: 10;
            margin-bottom: 8px;
        }
        .search-box input {
            width: 100%; padding: 10px 12px; border-radius: 8px;
            background: var(--surface2); color: var(--text);
            border: 1px solid var(--border); font-size: 14px; font-family: inherit;
        }
        .search-box input:focus { outline: none; border-color: var(--accent); }
        .search-box input::placeholder { color: var(--text-dim); }

        .item-card {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; border-radius: 8px;
            cursor: pointer; transition: all 0.15s;
            border: 1px solid transparent;
            margin-bottom: 2px;
        }
        .item-card:hover { background: var(--surface2); }
        .item-card.active {
            background: rgba(124,92,255,0.12);
            border-color: var(--accent);
        }
        .item-card.has-image { opacity: 0.55; }
        .item-card.has-image .item-status { color: var(--success); }

        .item-thumb {
            width: 40px; height: 40px; border-radius: 6px;
            background: var(--surface2); flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: var(--text-dim);
            overflow: hidden;
        }
        .item-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .item-info { flex: 1; min-width: 0; }
        .item-label { font-size: 14px; font-weight: 500; }
        .item-en { font-size: 12px; color: var(--text-dim); }
        .item-status { font-size: 16px; flex-shrink: 0; }

        /* === å³å´å·¥ä½œå€ === */
        .workspace {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 32px; position: relative;
        }

        /* ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center; color: var(--text-dim);
            font-size: 16px;
        }
        .empty-state .big-icon { font-size: 64px; margin-bottom: 16px; display: block; }

        /* é¸ä¸­é …ç›®çš„è©³æƒ… */
        .detail-panel {
            width: 100%; max-width: 680px;
            display: none; flex-direction: column; align-items: center; gap: 20px;
        }
        .detail-panel.visible { display: flex; }

        .detail-header {
            text-align: center;
        }
        .detail-header h2 { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .detail-header .detail-en { font-size: 14px; color: var(--text-dim); }
        .detail-header .detail-filename {
            margin-top: 8px; font-size: 13px;
            background: var(--surface2); padding: 6px 14px; border-radius: 6px;
            font-family: 'Consolas', monospace; color: var(--accent);
            display: inline-block; cursor: pointer;
        }
        .detail-header .detail-filename:hover { background: var(--border); }
        .detail-header .detail-filename::after { content: ' ğŸ“‹'; font-size: 11px; }

        /* æ‹–æ‹½/è²¼ä¸Šå€åŸŸ */
        .drop-zone {
            width: 100%; max-width: 480px; aspect-ratio: 1/1;
            border: 2px dashed var(--border); border-radius: var(--radius);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 12px;
            transition: all 0.2s; cursor: pointer;
            position: relative; overflow: hidden;
            background: var(--surface);
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent);
            background: rgba(124,92,255,0.05);
            box-shadow: 0 0 30px var(--accent-glow);
        }
        .drop-zone .drop-icon { font-size: 48px; }
        .drop-zone .drop-text { font-size: 14px; color: var(--text-dim); text-align: center; }
        .drop-zone .drop-text kbd {
            background: var(--surface2); padding: 2px 8px; border-radius: 4px;
            font-family: inherit; font-size: 13px; border: 1px solid var(--border);
        }
        .drop-zone.has-image { border-style: solid; border-color: var(--success); }
        .drop-zone .preview-img {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: contain; display: none;
        }
        .drop-zone.has-image .preview-img { display: block; }
        .drop-zone.has-image .drop-icon,
        .drop-zone.has-image .drop-text { display: none; }

        /* æ“ä½œæŒ‰éˆ• */
        .actions {
            display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;
        }
        .btn {
            padding: 10px 24px; border-radius: 8px; border: none;
            font-family: inherit; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.15s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #7c5cff, #6a4ee0);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px var(--accent-glow); }
        .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        .btn-success:hover { transform: translateY(-1px); box-shadow: 0 4px 16px var(--success-glow); }
        .btn-success:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-outline {
            background: transparent; border: 1px solid var(--border); color: var(--text);
        }
        .btn-outline:hover { background: var(--surface2); }

        /* GROK æç¤ºè©é¢æ¿ */
        .prompt-panel {
            width: 100%; max-width: 480px;
            background: var(--surface2); border-radius: var(--radius);
            padding: 14px; font-size: 13px;
        }
        .prompt-panel .prompt-title {
            font-size: 12px; color: var(--text-dim); margin-bottom: 6px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .prompt-panel .prompt-text {
            color: var(--text); font-family: 'Consolas', monospace;
            word-break: break-all; line-height: 1.6;
            user-select: all;
        }
        .prompt-panel .copy-btn {
            background: none; border: none; color: var(--accent);
            cursor: pointer; font-size: 12px; font-family: inherit;
        }
        .prompt-panel .copy-btn:hover { text-decoration: underline; }

        /* æ‰¹é‡æ¨¡å¼æŒ‡ç¤º */
        .batch-indicator {
            position: fixed; bottom: 24px; right: 24px;
            background: var(--accent); color: white;
            padding: 10px 20px; border-radius: 24px;
            font-size: 13px; font-weight: 600;
            box-shadow: 0 4px 20px var(--accent-glow);
            display: none; align-items: center; gap: 8px;
            z-index: 200;
        }
        .batch-indicator.visible { display: flex; }

        /* Toast é€šçŸ¥ */
        .toast {
            position: fixed; top: 80px; right: 24px; z-index: 300;
            background: var(--surface2); border: 1px solid var(--border);
            border-radius: 8px; padding: 12px 20px;
            font-size: 13px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transform: translateX(120%); transition: transform 0.3s ease;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }

        /* ç¯©é¸æŒ‰éˆ•çµ„ */
        .filter-tabs {
            display: flex; gap: 4px; flex-wrap: wrap;
        }
        .filter-tab {
            padding: 5px 12px; border-radius: 6px; border: none;
            background: var(--surface2); color: var(--text-dim);
            font-size: 12px; font-family: inherit; cursor: pointer;
            transition: all 0.15s;
        }
        .filter-tab:hover { color: var(--text); }
        .filter-tab.active { background: var(--accent); color: white; }

        /* åº•éƒ¨æ“ä½œåˆ— */
        .bottom-bar {
            position: sticky; bottom: 0;
            background: rgba(15,15,23,0.95); backdrop-filter: blur(12px);
            border-top: 1px solid var(--border);
            padding: 10px 24px;
            display: flex; align-items: center; gap: 16px;
        }
        .batch-toggle {
            display: flex; align-items: center; gap: 8px;
            font-size: 13px; color: var(--text-dim);
        }
        .batch-toggle input[type="checkbox"] {
            accent-color: var(--accent);
            width: 16px; height: 16px;
        }

        /* å·²æœ‰åœ–ç‰‡çš„é è¦½ */
        .existing-preview {
            width: 100%; max-width: 480px; aspect-ratio: 1/1;
            border-radius: var(--radius); overflow: hidden;
            border: 2px solid var(--success);
            position: relative;
        }
        .existing-preview img {
            width: 100%; height: 100%; object-fit: contain;
            background: var(--surface);
        }
        .existing-badge {
            position: absolute; top: 12px; right: 12px;
            background: var(--success); color: white;
            padding: 4px 12px; border-radius: 16px;
            font-size: 12px; font-weight: 600;
        }
        .replace-hint {
            font-size: 12px; color: var(--text-dim); text-align: center;
        }
    </style>
</head>
<body>

<!-- é ‚éƒ¨å·¥å…·åˆ— -->
<div class="toolbar">
    <h1>ğŸ–¼ï¸ Image Placer</h1>
    <select id="categorySelect">
        <option value="">â€” é¸æ“‡é¡åˆ¥ â€”</option>
    </select>
    <div class="filter-tabs" id="filterTabs">
        <button class="filter-tab active" data-filter="all">å…¨éƒ¨</button>
        <button class="filter-tab" data-filter="missing">âŒ ç¼ºåœ–</button>
        <button class="filter-tab" data-filter="done">âœ… å·²æœ‰</button>
    </div>
    <div class="stats">
        <span>âœ… å·²å®Œæˆ: <span class="done" id="doneCount">0</span></span>
        <span>âŒ ç¼ºåœ–: <span class="missing" id="missingCount">0</span></span>
        <span id="totalCount"></span>
    </div>
</div>
<div class="progress-bar-wrap"><div class="progress-bar-fill" id="progressBar" style="width:0%"></div></div>

<!-- ä¸»å€åŸŸ -->
<div class="main">
    <!-- å·¦å´é¸é …åˆ—è¡¨ -->
    <div class="item-list" id="itemList">
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹é¸é …..." />
        </div>
        <div id="itemContainer"></div>
    </div>

    <!-- å³å´å·¥ä½œå€ -->
    <div class="workspace" id="workspace">
        <div class="empty-state" id="emptyState">
            <span class="big-icon">ğŸ‘ˆ</span>
            è«‹å…ˆé¸æ“‡ä¸€å€‹é¡åˆ¥ï¼Œ<br>ç„¶å¾Œé»æ“Šå·¦å´çš„é¸é …
        </div>
        <div class="detail-panel" id="detailPanel">
            <div class="detail-header">
                <h2 id="detailLabel"></h2>
                <div class="detail-en" id="detailEn"></div>
                <div class="detail-filename" id="detailFilename" title="é»æ“Šè¤‡è£½æª”å"></div>
            </div>

            <!-- GROK æç¤ºè© -->
            <div class="prompt-panel">
                <div class="prompt-title">
                    <span>ğŸ“ GROK ç”Ÿåœ–æç¤ºè©</span>
                    <button class="copy-btn" id="copyPromptBtn">è¤‡è£½æç¤ºè©</button>
                </div>
                <div class="prompt-text" id="promptText"></div>
            </div>

            <!-- æ‹–æ‹½/è²¼ä¸Šå€åŸŸ æˆ– å·²æœ‰åœ–ç‰‡ -->
            <div id="imageArea"></div>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="actions" id="actionButtons"></div>
        </div>
    </div>
</div>

<!-- åº•éƒ¨æ“ä½œåˆ— -->
<div class="bottom-bar">
    <label class="batch-toggle">
        <input type="checkbox" id="batchMode" />
        âš¡ æ‰¹é‡æ¨¡å¼ï¼ˆä¸‹è¼‰å¾Œè‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹ç¼ºåœ–é …ç›®ï¼‰
    </label>
</div>

<!-- Toast é€šçŸ¥ -->
<div class="toast" id="toast"></div>

<!-- æ‰¹é‡æ¨¡å¼æŒ‡ç¤º -->
<div class="batch-indicator" id="batchIndicator">âš¡ æ‰¹é‡æ¨¡å¼</div>

<script>
// ============================================
// Image Placer Tool â€” æ ¸å¿ƒé‚è¼¯
// ============================================

// === è³‡æ–™å®šç¾© (ç›´æ¥åµŒå…¥ï¼Œé¿å…è·¨åŸŸå•é¡Œ) ===
// æˆ‘å€‘éœ€è¦å¾ options-data.js è®€å–ï¼Œä½†ç”±æ–¼æ˜¯æœ¬åœ°æª”æ¡ˆï¼Œç›´æ¥ç”¨ script æ¨™ç±¤è¼‰å…¥

let DATA = null;

// é¡åˆ¥æ˜ å°„: categoryKey â†’ { prefix, data, label }
const CATEGORIES = {};

function initCategories() {
    const D = DATA;
    const cats = {
        // éœ€è¦é è¦½åœ–çš„ä¸»è¦é¡åˆ¥
        race:             { prefix: 'race',      data: D.RACES,             label: 'ğŸ§ ç¨®æ— Race' },
        job:              { prefix: 'job',        data: D.JOBS,              label: 'âš”ï¸ è·æ¥­ Job' },
        hairstyle_female: { prefix: 'hair',       data: D.HAIRSTYLES_FEMALE, label: 'ğŸ’‡â€â™€ï¸ å¥³æ€§é«®å‹' },
        hairstyle_male:   { prefix: 'hair_m',     data: D.HAIRSTYLES_MALE,   label: 'ğŸ’‡â€â™‚ï¸ ç”·æ€§é«®å‹' },
        outfit:           { prefix: 'clothing',   data: D.OUTFITS,           label: 'ğŸ‘— æœè£ Outfit' },
        lighting:         { prefix: 'lighting',   data: D.LIGHTING,          label: 'ğŸ’¡ å…‰å½± Lighting' },
        scene:            { prefix: 'scene',      data: D.SCENES,            label: 'ğŸï¸ å ´æ™¯ Scene' },
        expression:       { prefix: 'expr',       data: D.EXPRESSIONS,       label: 'ğŸ˜€ è¡¨æƒ… Expression' },
        mood:             { prefix: 'mood',       data: D.MOODS,             label: 'ğŸ’­ å¿ƒæƒ… Mood' },
        anime_style:      { prefix: 'anime',      data: D.ANIME_STYLES,      label: 'ğŸ¨ å‹•æ¼«é¢¨æ ¼' },
        art_style:        { prefix: 'art',        data: D.ART_STYLES,        label: 'ğŸ–Œï¸ è—è¡“é¢¨æ ¼' },
        body_female:      { prefix: 'body_f',     data: D.BODY_TYPES_FEMALE, label: 'ğŸšº å¥³æ€§é«”å‹' },
        body_male:        { prefix: 'body_m',     data: D.BODY_TYPES_MALE,   label: 'ğŸš¹ ç”·æ€§é«”å‹' },
    };
    Object.assign(CATEGORIES, cats);
}

// === å·¥å…·å‡½æ•¸ ===
function toSnakeCase(str) {
    return str
        .toLowerCase()
        .replace(/['']/g, '')
        .replace(/[^a-z0-9]+/g, '_')
        .replace(/^_|_$/g, '');
}

function getFilename(prefix, en) {
    return `${prefix}_${toSnakeCase(en)}.png`;
}

function getImagePath(prefix, en) {
    return `assets/previews/${getFilename(prefix, en)}`;
}

// ç”Ÿæˆ GROK æç¤ºè©
function generatePrompt(item, categoryKey) {
    const base = 'A single character preview icon, clean white background, facing forward, upper body portrait, anime style, high quality, detailed';
    const cat = CATEGORIES[categoryKey];
    
    if (categoryKey === 'race') {
        return `${base}, ${item.value}, fantasy character design`;
    } else if (categoryKey === 'job') {
        return `${base}, ${item.value}, professional outfit and equipment`;
    } else if (categoryKey.startsWith('hairstyle')) {
        return `${base}, beautiful girl with ${item.value}, focus on hairstyle detail`;
    } else if (categoryKey === 'outfit') {
        return `${base}, beautiful girl wearing ${item.value}, full outfit visible`;
    } else if (categoryKey === 'lighting') {
        return `${base}, beautiful portrait with ${item.value}, dramatic lighting demonstration`;
    } else if (categoryKey === 'scene') {
        return `Background scene illustration, no characters, ${item.value}, wide angle, detailed environment`;
    } else if (categoryKey === 'expression' || categoryKey === 'mood') {
        return `${base}, beautiful girl face, ${item.value}, focus on facial expression`;
    } else if (categoryKey.startsWith('anime_style') || categoryKey.startsWith('art_style')) {
        return `Character illustration sample, ${item.value}, demonstration of art style`;
    } else if (categoryKey.startsWith('body')) {
        return `${base}, ${item.value}, body type reference`;
    }
    return `${base}, ${item.value}`;
}

// === ç‹€æ…‹ç®¡ç† ===
let currentCategory = '';
let currentFilter = 'all';
let currentSearch = '';
let currentItem = null;
let currentImageBlob = null;

// === DOM å…ƒç´  ===
const $ = id => document.getElementById(id);
const categorySelect = $('categorySelect');
const itemContainer = $('itemContainer');
const searchInput = $('searchInput');
const emptyState = $('emptyState');
const detailPanel = $('detailPanel');
const progressBar = $('progressBar');
const doneCount = $('doneCount');
const missingCount = $('missingCount');
const totalCount = $('totalCount');
const toast = $('toast');
const batchMode = $('batchMode');
const batchIndicator = $('batchIndicator');

// === Toast ç³»çµ± ===
let toastTimer = null;
function showToast(msg, type = '') {
    clearTimeout(toastTimer);
    toast.textContent = msg;
    toast.className = `toast ${type} show`;
    toastTimer = setTimeout(() => toast.classList.remove('show'), 2500);
}

// === åˆå§‹åŒ–é¡åˆ¥ä¸‹æ‹‰é¸å–® ===
function initCategorySelect() {
    for (const [key, cat] of Object.entries(CATEGORIES)) {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = `${cat.label} (${cat.data.length})`;
        categorySelect.appendChild(opt);
    }
}

// === æ¸²æŸ“é¸é …åˆ—è¡¨ ===
function renderItems() {
    if (!currentCategory) {
        itemContainer.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:40px;">è«‹å…ˆé¸æ“‡é¡åˆ¥</div>';
        updateStats(0, 0, 0);
        return;
    }
    const cat = CATEGORIES[currentCategory];
    const items = cat.data;
    let doneN = 0, missingN = 0;

    const fragment = document.createDocumentFragment();

    items.forEach((item, idx) => {
        const hasImage = !!item.image;
        if (hasImage) doneN++; else missingN++;

        // ç¯©é¸
        if (currentFilter === 'missing' && hasImage) return;
        if (currentFilter === 'done' && !hasImage) return;

        // æœå°‹
        if (currentSearch) {
            const q = currentSearch.toLowerCase();
            if (!item.label.toLowerCase().includes(q) && 
                !item.en.toLowerCase().includes(q) &&
                !item.value.toLowerCase().includes(q)) return;
        }

        const card = document.createElement('div');
        card.className = `item-card ${hasImage ? 'has-image' : ''} ${currentItem === idx ? 'active' : ''}`;
        card.dataset.idx = idx;
        
        const expectedPath = hasImage ? item.image : getImagePath(cat.prefix, item.en);
        
        card.innerHTML = `
            <div class="item-thumb">${hasImage ? `<img src="../${item.image}" onerror="this.style.display='none';this.parentElement.textContent='?'" />` : '?'}</div>
            <div class="item-info">
                <div class="item-label">${item.label}</div>
                <div class="item-en">${item.en}</div>
            </div>
            <div class="item-status">${hasImage ? 'âœ…' : 'âŒ'}</div>
        `;

        card.addEventListener('click', () => selectItem(idx));
        fragment.appendChild(card);
    });

    itemContainer.innerHTML = '';
    itemContainer.appendChild(fragment);
    updateStats(doneN, missingN, items.length);
}

function updateStats(done, missing, total) {
    doneCount.textContent = done;
    missingCount.textContent = missing;
    totalCount.textContent = `(å…± ${total} é …)`;
    const pct = total > 0 ? (done / total * 100) : 0;
    progressBar.style.width = pct + '%';
}

// === é¸æ“‡é …ç›® ===
function selectItem(idx) {
    const cat = CATEGORIES[currentCategory];
    const item = cat.data[idx];
    currentItem = idx;
    currentImageBlob = null;

    // æ›´æ–°å·¦å´é«˜äº®
    document.querySelectorAll('.item-card').forEach(c => c.classList.remove('active'));
    const activeCard = document.querySelector(`.item-card[data-idx="${idx}"]`);
    if (activeCard) activeCard.classList.add('active');

    // é¡¯ç¤ºè©³æƒ…é¢æ¿
    emptyState.style.display = 'none';
    detailPanel.classList.add('visible');

    const filename = getFilename(cat.prefix, item.en);
    const filepath = getImagePath(cat.prefix, item.en);

    $('detailLabel').textContent = item.label;
    $('detailEn').textContent = item.en + '  â†’  ' + item.value;
    $('detailFilename').textContent = filename;
    $('detailFilename').dataset.filename = filename;
    $('detailFilename').onclick = () => {
        navigator.clipboard.writeText(filename);
        showToast('âœ… æª”åå·²è¤‡è£½!', 'success');
    };

    // æç¤ºè©
    const prompt = generatePrompt(item, currentCategory);
    $('promptText').textContent = prompt;
    $('copyPromptBtn').onclick = () => {
        navigator.clipboard.writeText(prompt);
        showToast('âœ… æç¤ºè©å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿!', 'success');
    };

    // åœ–ç‰‡å€åŸŸ
    const imageArea = $('imageArea');
    const hasImage = !!item.image;

    if (hasImage) {
        imageArea.innerHTML = `
            <div class="existing-preview">
                <img src="../${item.image}" alt="${item.en}" />
                <span class="existing-badge">âœ… å·²æœ‰åœ–ç‰‡</span>
            </div>
            <div class="replace-hint">å¦‚éœ€æ›¿æ›ï¼Œå¯åœ¨ä¸‹æ–¹è²¼ä¸Šæ–°åœ–ç‰‡</div>
            <div class="drop-zone" id="dropZone" style="max-height:200px;aspect-ratio:auto;">
                <span class="drop-icon" style="font-size:28px;">ğŸ“‹</span>
                <span class="drop-text" style="font-size:12px;"><kbd>Ctrl+V</kbd> è²¼ä¸Šæ–°åœ–ç‰‡æ›¿æ›</span>
                <img class="preview-img" id="previewImg" />
            </div>
        `;
    } else {
        imageArea.innerHTML = `
            <div class="drop-zone" id="dropZone">
                <span class="drop-icon">ğŸ“‹</span>
                <div class="drop-text">
                    <kbd>Ctrl+V</kbd> è²¼ä¸Šåœ–ç‰‡<br>
                    æˆ–æ‹–æ‹½åœ–ç‰‡åˆ°é€™è£¡
                </div>
                <img class="preview-img" id="previewImg" />
            </div>
        `;
    }

    // æŒ‰éˆ•
    const btns = $('actionButtons');
    btns.innerHTML = `
        <button class="btn btn-primary" id="downloadBtn" disabled>
            ğŸ’¾ ä¸‹è¼‰ç‚º ${filename}
        </button>
        <button class="btn btn-outline" id="clearBtn" style="display:none;">
            ğŸ—‘ï¸ æ¸…é™¤
        </button>
    `;

    // ç¶å®šäº‹ä»¶
    setupDropZone();
    $('downloadBtn').onclick = downloadImage;
    $('clearBtn').onclick = clearImage;
}

// === æ‹–æ‹½/è²¼ä¸Š ===
function setupDropZone() {
    const dz = $('dropZone');
    if (!dz) return;

    dz.addEventListener('dragover', e => {
        e.preventDefault();
        dz.classList.add('dragover');
    });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', e => {
        e.preventDefault();
        dz.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            loadImage(file);
        }
    });
    dz.addEventListener('click', () => {
        // é»æ“Šä¹Ÿå¯ä»¥é¸æ“‡æª”æ¡ˆ
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = e => {
            if (e.target.files[0]) loadImage(e.target.files[0]);
        };
        input.click();
    });
}

// å…¨åŸŸ Ctrl+V ç›£è½
document.addEventListener('paste', e => {
    if (currentItem === null) return;
    const items = e.clipboardData.items;
    for (const item of items) {
        if (item.type.startsWith('image/')) {
            e.preventDefault();
            const blob = item.getAsFile();
            loadImage(blob);
            return;
        }
    }
});

function loadImage(file) {
    const reader = new FileReader();
    reader.onload = e => {
        const img = $('previewImg');
        const dz = $('dropZone');
        if (!img || !dz) return;
        
        img.src = e.target.result;
        dz.classList.add('has-image');
        
        // è½‰æ›ç‚º PNG blob
        const canvas = document.createElement('canvas');
        const tempImg = new Image();
        tempImg.onload = () => {
            canvas.width = tempImg.naturalWidth;
            canvas.height = tempImg.naturalHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(tempImg, 0, 0);
            canvas.toBlob(blob => {
                currentImageBlob = blob;
                $('downloadBtn').disabled = false;
                $('clearBtn').style.display = '';
                showToast('âœ… åœ–ç‰‡å·²è¼‰å…¥ï¼æŒ‰ã€Œä¸‹è¼‰ã€ä¿å­˜', 'success');
            }, 'image/png');
        };
        tempImg.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function clearImage() {
    currentImageBlob = null;
    const dz = $('dropZone');
    if (dz) {
        dz.classList.remove('has-image');
        const img = $('previewImg');
        if (img) img.src = '';
    }
    $('downloadBtn').disabled = true;
    $('clearBtn').style.display = 'none';
}

// === ä¸‹è¼‰åœ–ç‰‡ ===
function downloadImage() {
    if (!currentImageBlob || currentItem === null) return;
    const cat = CATEGORIES[currentCategory];
    const item = cat.data[currentItem];
    const filename = getFilename(cat.prefix, item.en);

    const url = URL.createObjectURL(currentImageBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showToast(`âœ… å·²ä¸‹è¼‰: ${filename}`, 'success');

    // æ‰¹é‡æ¨¡å¼ï¼šè‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹ç¼ºåœ–é …ç›®
    if (batchMode.checked) {
        setTimeout(() => jumpToNextMissing(), 500);
    }
}

function jumpToNextMissing() {
    const cat = CATEGORIES[currentCategory];
    const items = cat.data;
    for (let i = currentItem + 1; i < items.length; i++) {
        if (!items[i].image) {
            selectItem(i);
            // æ»¾å‹•åˆ°å¯è¦‹
            const card = document.querySelector(`.item-card[data-idx="${i}"]`);
            if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
    }
    // å¦‚æœå¾Œé¢æ²’æœ‰äº†ï¼Œå¾é ­æ‰¾
    for (let i = 0; i < currentItem; i++) {
        if (!items[i].image) {
            selectItem(i);
            const card = document.querySelector(`.item-card[data-idx="${i}"]`);
            if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
    }
    showToast('ğŸ‰ é€™å€‹é¡åˆ¥å…¨éƒ¨å®Œæˆå›‰ï¼', 'success');
}

// === äº‹ä»¶ç¶å®š ===
categorySelect.addEventListener('change', e => {
    currentCategory = e.target.value;
    currentItem = null;
    currentImageBlob = null;
    detailPanel.classList.remove('visible');
    emptyState.style.display = '';
    emptyState.innerHTML = '<span class="big-icon">ğŸ‘ˆ</span>é»æ“Šå·¦å´çš„é¸é …é–‹å§‹';
    renderItems();
});

searchInput.addEventListener('input', e => {
    currentSearch = e.target.value;
    renderItems();
});

document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.dataset.filter;
        renderItems();
    });
});

batchMode.addEventListener('change', () => {
    batchIndicator.classList.toggle('visible', batchMode.checked);
});

// === è¼‰å…¥è³‡æ–™ ===
const script = document.createElement('script');
script.src = '../data/options-data.js';
script.onload = () => {
    DATA = window.PromptGen.Data;
    initCategories();
    initCategorySelect();
    showToast('âœ… è³‡æ–™è¼‰å…¥å®Œæˆï¼é¸æ“‡é¡åˆ¥é–‹å§‹', 'success');
};
script.onerror = () => {
    showToast('âŒ ç„¡æ³•è¼‰å…¥ options-data.js! è«‹ç¢ºèªæª”æ¡ˆè·¯å¾‘', 'error');
    document.body.innerHTML += '<div style="text-align:center;padding:40px;color:#ef4444;font-size:18px;">âŒ ç„¡æ³•è¼‰å…¥ data/options-data.js<br><br>è«‹ç¢ºèªé€™å€‹é é¢åœ¨å°ˆæ¡ˆçš„ tools/ ç›®éŒ„ä¸‹é–‹å•Ÿ<br>ä¸”ä¸Šå±¤æœ‰ data/options-data.js æª”æ¡ˆ</div>';
};
document.head.appendChild(script);
</script>
</body>
</html>
