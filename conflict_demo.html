<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš”ï¸ ç¨®æ—Ã—è·æ¥­ è¡çªåµæ¸¬ Demo v3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 50%, #0d0d2b 100%);
            color: #e0e0ff;
            min-height: 100vh;
            padding: 30px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.6rem;
            margin-bottom: 6px;
            text-align: center;
        }

        .sub {
            color: #8888bb;
            margin-bottom: 25px;
            font-size: 0.85rem;
            text-align: center;
        }

        .section-label {
            font-size: 1rem;
            color: #aaddff;
            margin: 20px 0 10px;
            padding-left: 8px;
            border-left: 3px solid #6688ff;
        }

        .tag-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-btn {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            padding: 8px 14px;
            color: #ccc;
            cursor: pointer;
            font-size: 0.82rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tag-btn:hover {
            background: rgba(100, 150, 255, 0.15);
            border-color: rgba(100, 150, 255, 0.4);
            color: #fff;
        }

        .tag-btn.active {
            background: linear-gradient(135deg, #bb86fc, #9965f4);
            border-color: #bb86fc;
            color: #fff;
            font-weight: 600;
            box-shadow: 0 2px 12px rgba(187, 134, 252, 0.35);
        }

        .status-bar {
            margin-top: 25px;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 0.88rem;
            line-height: 1.6;
        }

        .status-bar .label {
            color: #8888bb;
            font-size: 0.75rem;
            margin-bottom: 4px;
        }

        .status-bar .value {
            color: #bb86fc;
            font-weight: 600;
        }

        .prompt-output {
            margin-top: 15px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            color: #D4A574;
            white-space: pre-wrap;
            min-height: 40px;
        }

        /* Settings panel */
        .settings-panel {
            margin-top: 20px;
            padding: 16px 18px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
        }

        .settings-panel h3 {
            font-size: 0.9rem;
            color: #aaddff;
            margin-bottom: 10px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 0.82rem;
            color: #ccc;
        }

        .setting-value {
            font-size: 0.78rem;
            color: #bb86fc;
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 42px;
            height: 22px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 22px;
            transition: 0.3s;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            left: 3px;
            top: 3px;
            background: #fff;
            transition: 0.3s;
        }

        .toggle-switch input:checked+.toggle-slider {
            background: #bb86fc;
        }

        .toggle-switch input:checked+.toggle-slider::before {
            transform: translateX(20px);
        }

        /* ================================ */
        /* CONFLICT WARNING MODAL           */
        /* ================================ */
        .conflict-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .conflict-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .conflict-bg {
            position: absolute;
            inset: 0;
            animation: bg-pulse 0.8s ease-in-out infinite alternate;
        }

        @keyframes bg-pulse {
            0% {
                background: rgba(80, 0, 0, 0.6);
            }

            100% {
                background: rgba(20, 0, 0, 0.75);
            }
        }

        .conflict-modal {
            position: relative;
            width: 500px;
            max-width: 92vw;
            background: linear-gradient(145deg, #1a0a0a 0%, #2a1020 40%, #1a0a1a 100%);
            border: 2px solid #ff2244;
            border-radius: 16px;
            padding: 0;
            overflow: hidden;
            transform: scale(0.3);
            opacity: 0;
            animation: modal-enter 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            box-shadow: 0 0 30px rgba(255, 34, 68, 0.4), 0 0 60px rgba(255, 34, 68, 0.2),
                0 0 100px rgba(255, 34, 68, 0.1), inset 0 0 30px rgba(255, 34, 68, 0.05);
        }

        .conflict-overlay.active .conflict-modal {
            animation: modal-enter 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards,
                border-glow 0.8s ease-in-out 0.4s infinite alternate;
        }

        @keyframes modal-enter {
            0% {
                transform: scale(0.3) rotate(-2deg);
                opacity: 0;
            }

            60% {
                transform: scale(1.05) rotate(0.5deg);
                opacity: 1;
            }

            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        @keyframes border-glow {
            0% {
                border-color: #ff2244;
                box-shadow: 0 0 30px rgba(255, 34, 68, 0.5), 0 0 60px rgba(255, 34, 68, 0.3),
                    0 0 100px rgba(255, 34, 68, 0.15), inset 0 0 30px rgba(255, 34, 68, 0.08);
            }

            100% {
                border-color: #cc1133;
                box-shadow: 0 0 15px rgba(255, 34, 68, 0.25), 0 0 30px rgba(255, 34, 68, 0.1),
                    inset 0 0 15px rgba(255, 34, 68, 0.03);
            }
        }

        .conflict-header {
            background: linear-gradient(90deg, #ff1133 0%, #cc0033 50%, #ff1133 100%);
            background-size: 200% 100%;
            animation: header-shift 2s ease infinite;
            padding: 16px 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        @keyframes header-shift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .conflict-header::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(90deg, transparent, transparent 20px,
                    rgba(0, 0, 0, 0.1) 20px, rgba(0, 0, 0, 0.1) 22px);
            animation: stripe-move 1s linear infinite;
        }

        @keyframes stripe-move {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(22px);
            }
        }

        .conflict-title {
            font-size: 1.3rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: title-shake 0.5s ease-in-out 0.3s;
        }

        @keyframes title-shake {

            0%,
            100% {
                transform: translateX(0);
            }

            15% {
                transform: translateX(-6px) rotate(-1deg);
            }

            30% {
                transform: translateX(5px) rotate(1deg);
            }

            45% {
                transform: translateX(-4px);
            }

            60% {
                transform: translateX(3px);
            }

            75% {
                transform: translateX(-2px);
            }
        }

        .conflict-subtitle {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
            position: relative;
            letter-spacing: 2px;
        }

        .conflict-body {
            padding: 20px 24px;
        }

        .conflict-desc {
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.7;
            color: #ddd;
            margin-bottom: 8px;
            text-align: center;
            white-space: nowrap;
        }

        .conflict-combo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 16px 0;
            font-size: 1rem;
        }

        .combo-tag {
            padding: 6px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .combo-race {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff8888;
        }

        .combo-job {
            background: rgba(68, 136, 255, 0.2);
            border: 1px solid #4488ff;
            color: #88bbff;
        }

        .combo-x {
            font-size: 1.4rem;
            color: #ff4444;
            font-weight: 900;
            text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
            animation: x-pulse 0.6s ease-in-out infinite alternate;
        }

        @keyframes x-pulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }

            100% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .conflict-reason {
            font-size: 0.8rem;
            color: #aa8888;
            text-align: center;
            margin-bottom: 16px;
            font-style: italic;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 6px;
        }

        .reason-hint {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #aa8888;
            font-size: 0.65rem;
            font-style: normal;
            font-weight: 700;
            cursor: help;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .reason-hint:hover {
            background: rgba(255, 68, 68, 0.2);
            border-color: #ff4444;
            color: #ff8888;
        }

        .reason-hint .hint-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            right: -6px;
            transform: scale(0.9);
            background: rgba(30, 10, 10, 0.95);
            border: 1px solid rgba(255, 68, 68, 0.4);
            border-radius: 8px;
            padding: 8px 14px;
            color: #ff8888;
            font-size: 0.78rem;
            font-style: normal;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px rgba(255, 34, 68, 0.2);
        }

        .reason-hint .hint-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 10px;
            border: 5px solid transparent;
            border-top-color: rgba(255, 68, 68, 0.4);
        }

        .reason-hint:hover .hint-tooltip {
            opacity: 1;
            transform: scale(1);
        }

        .conflict-prompt-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 8px;
        }

        .conflict-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .conflict-option {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.25s;
            text-align: left;
            font-family: inherit;
            color: inherit;
        }

        .conflict-option:hover {
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }

        .conflict-option:active {
            transform: scale(0.98);
        }

        .option-title {
            font-size: 0.92rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .option-desc {
            font-size: 0.75rem;
            color: #999;
            line-height: 1.4;
        }

        .option-1 .option-title {
            color: #ff8844;
        }

        .option-1:hover {
            border-color: rgba(255, 136, 68, 0.4);
            box-shadow: 0 0 15px rgba(255, 136, 68, 0.1);
        }

        .option-2 .option-title {
            color: #44aaff;
        }

        .option-2:hover {
            border-color: rgba(68, 170, 255, 0.4);
            box-shadow: 0 0 15px rgba(68, 170, 255, 0.1);
        }

        .option-3 .option-title {
            color: #44ff88;
        }

        .option-3:hover {
            border-color: rgba(68, 255, 136, 0.4);
            box-shadow: 0 0 15px rgba(68, 255, 136, 0.1);
        }

        /* Remember choice */
        .remember-choice {
            margin-top: 14px;
            padding: 12px 14px;
            background: rgba(187, 134, 252, 0.06);
            border: 1px solid rgba(187, 134, 252, 0.2);
            border-radius: 8px;
            display: none;
        }

        .remember-choice.visible {
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeSlideIn 0.3s ease forwards;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .remember-choice input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #bb86fc;
            cursor: pointer;
            flex-shrink: 0;
        }

        .remember-choice label {
            font-size: 0.8rem;
            color: #bb86fc;
            cursor: pointer;
            line-height: 1.4;
        }

        .remember-choice .hint {
            font-size: 0.7rem;
            color: #888;
            margin-top: 2px;
        }

        .conflict-counter {
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 0;
            z-index: 1;
        }

        /* Screen effects */
        .screen-flash {
            position: fixed;
            inset: 0;
            background: rgba(255, 0, 0, 0.3);
            z-index: 9998;
            pointer-events: none;
            opacity: 0;
        }

        .screen-flash.active {
            animation: flash-hit 0.4s ease-out forwards;
        }

        @keyframes flash-hit {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        body.screen-shake {
            animation: shake-screen 0.4s ease-in-out;
        }

        @keyframes shake-screen {

            0%,
            100% {
                transform: translate(0);
            }

            10% {
                transform: translate(-4px, 2px);
            }

            20% {
                transform: translate(4px, -2px);
            }

            30% {
                transform: translate(-3px, 1px);
            }

            40% {
                transform: translate(3px, -1px);
            }

            50% {
                transform: translate(-2px, 1px);
            }

            60% {
                transform: translate(2px, 0);
            }

            70% {
                transform: translate(-1px, 0);
            }
        }

        .resolution-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid rgba(187, 134, 252, 0.4);
            border-radius: 12px;
            padding: 14px 24px;
            color: #ddd;
            font-size: 0.85rem;
            z-index: 10000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 500px;
            text-align: center;
        }

        .resolution-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>âš”ï¸ ç¨®æ— Ã— è·æ¥­ è¡çªåµæ¸¬ Demo v3</h1>
        <p class="sub">ğŸ”§ é€šç”¨è¡çªå¼•æ“ Â· æ”¯æ´ä»»æ„åˆ†é¡é–“çš„è¡çªåˆ¤æ–·</p>

        <div class="section-label">ğŸ§¬ ç¨®æ— (Race)</div>
        <div class="tag-grid" id="race-grid"></div>

        <div class="section-label">âš”ï¸ è·æ¥­ (Job)</div>
        <div class="tag-grid" id="job-grid"></div>

        <div class="status-bar">
            <div class="label">ç›®å‰é¸æ“‡</div>
            <div>ç¨®æ—: <span class="value" id="status-race">æœªé¸æ“‡</span></div>
            <div>è·æ¥­: <span class="value" id="status-job">æœªé¸æ“‡</span></div>
            <div>è¡çªç‹€æ…‹: <span class="value" id="status-conflict">ç„¡</span></div>
            <div>è™•ç†æ–¹å¼: <span class="value" id="status-resolution">â€”</span></div>
            <div>è­¦å‘Šæ¬¡æ•¸: <span class="value" id="status-count">0</span></div>
        </div>

        <div class="prompt-output" id="prompt-output">ï¼ˆé¸æ“‡ç¨®æ—å’Œè·æ¥­å¾Œç”Ÿæˆï¼‰</div>

        <div class="settings-panel">
            <h3>âš™ï¸ è¨­å®š (Settings) â€” è¡çªåµæ¸¬</h3>
            <div class="setting-row">
                <div>
                    <div class="setting-label">å•Ÿç”¨è¡çªè­¦å‘Š</div>
                    <div class="setting-value">ä»»ä½•åˆ†é¡é–“çš„è¡çªéƒ½æœƒé¡¯ç¤ºè­¦å‘Šå½ˆçª—</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-warnings-enabled" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="setting-row">
                <div>
                    <div class="setting-label">è‡ªå‹•è™•ç†æ–¹å¼</div>
                    <div class="setting-value" id="setting-auto-mode">æœªè¨­å®šï¼ˆæ¯æ¬¡è©¢å•ï¼‰</div>
                </div>
                <button id="setting-reset-auto"
                    style="background:rgba(255,68,68,0.15);border:1px solid rgba(255,68,68,0.3);color:#ff8888;padding:4px 12px;border-radius:6px;font-size:0.75rem;cursor:pointer;font-family:inherit;">
                    é‡ç½®
                </button>
            </div>
        </div>
    </div>

    <div class="screen-flash" id="screen-flash"></div>

    <!-- Conflict Warning Modal -->
    <div class="conflict-overlay" id="conflict-overlay">
        <div class="conflict-bg"></div>
        <div class="conflict-modal">
            <div class="conflict-header">
                <div class="conflict-title">âš ï¸ å±éšª! é­”æ³•éŒ¯èª¤è­¦å‘Š!</div>
                <div class="conflict-subtitle">MAGIC CONFLICT DETECTED</div>
                <div class="conflict-counter" id="conflict-counter"></div>
            </div>
            <div class="conflict-body">
                <div class="conflict-combo">
                    <span class="combo-tag combo-race" id="combo-a">â€”</span>
                    <span class="combo-x">âœ•</span>
                    <span class="combo-tag combo-job" id="combo-b">â€”</span>
                </div>
                <div class="conflict-desc" id="conflict-desc"></div>
                <div class="conflict-reason">
                    <span id="conflict-reason"></span>
                    <span class="reason-hint">?
                        <span class="hint-tooltip">AI å¯èƒ½å°‡æ­¤è§£è®€ç‚ºå…©å€‹ä¸åŒè§’è‰²</span>
                    </span>
                </div>

                <div class="conflict-prompt-label">è«‹é¸æ“‡è™•ç†æ–¹å¼:</div>
                <div class="conflict-options">
                    <button class="conflict-option option-1" onclick="resolve('ignore')">
                        <div class="option-title">ğŸ”¥ å¿½ç•¥è­¦å‘Šï¼Œç¹¼çºŒåŸ·è¡Œ</div>
                        <div class="option-desc">âš  å¯èƒ½ç”¢ç”Ÿå…©å€‹è§’è‰²çš„åœ–ç‰‡ï¼Œä½†ä¿ç•™ä½ çš„åŸå§‹è¨­å®š</div>
                    </button>
                    <button class="conflict-option option-2" onclick="resolve('dual')">
                        <div class="option-title">ğŸ‘¥ æ¥å—é›™äººæ§‹åœ–</div>
                        <div class="option-desc">ç³»çµ±åŠ å…¥ã€Œ2charactersã€æç¤ºè©ï¼Œæ˜ç¢ºç”Ÿæˆé›™è§’è‰²æ§‹åœ–</div>
                    </button>
                    <button class="conflict-option option-3" onclick="resolve('merge')">
                        <div class="option-title">âœ¨ åˆä½µç‚ºä¸€é«”</div>
                        <div class="option-desc">ç³»çµ±å¼·èª¿ã€Œä¸€å€‹è§’è‰²åŒæ™‚å…·æœ‰å…©ç¨®ç‰¹è³ªã€ï¼Œé¿å…åˆ†è£‚</div>
                    </button>
                </div>

                <div class="remember-choice" id="remember-choice">
                    <input type="checkbox" id="remember-checkbox">
                    <div>
                        <label for="remember-checkbox">ä»¥å¾Œéƒ½ç”¨æ­¤æ–¹å¼è™•ç†ï¼Œä¸å†é¡¯ç¤ºè­¦å‘Š</label>
                        <div class="hint">å¯åœ¨ã€Œè¨­å®šã€ä¸­éš¨æ™‚é‡æ–°é–‹å•Ÿè­¦å‘Š</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="resolution-toast" id="resolution-toast"></div>

    <script>
        // ============================
        // DATA
        // ============================
        const RACES = [
            { label: 'äººé¡', en: 'Human', value: 'human' },
            { label: 'ç²¾éˆ', en: 'Elf', value: 'elf' },
            { label: 'å¤©ä½¿', en: 'Angel', value: 'angel, wings, halo' },
            { label: 'æƒ¡é­”', en: 'Demon', value: 'demon, horns, wings, tail' },
            { label: 'å¸è¡€é¬¼', en: 'Vampire', value: 'vampire, pale skin, red eyes, fangs' },
            { label: 'é¾äºº', en: 'Dragon', value: 'dragon girl, dragon horns, tail, scales' },
            { label: 'æ©Ÿå™¨äºº', en: 'Android', value: 'android, robot, mechanical parts' },
            { label: 'å¹½éˆ', en: 'Ghost', value: 'ghost, translucent, spirit' },
            { label: 'äººé­š', en: 'Mermaid', value: 'mermaid, fish tail, underwater' },
            { label: 'å¦–ç²¾', en: 'Fairy', value: 'fairy, small wings, tiny' },
            { label: 'æ®­å±', en: 'Zombie', value: 'zombie, pale, undead' },
            { label: 'å²èŠå§†', en: 'Slime', value: 'slime girl, translucent skin' },
            { label: 'è²“å¨˜', en: 'Cat Girl', value: 'cat girl, cat ears, cat tail' },
            { label: 'ç‹å¨˜', en: 'Fox Girl', value: 'fox girl, fox ears, multiple tails' }
        ];

        const JOBS = [
            { label: 'å¥³åƒ•', en: 'Maid', value: 'maid, maid headdress' },
            { label: 'å­¸ç”Ÿ', en: 'Student', value: 'student, school uniform' },
            { label: 'å·«å¥³', en: 'Shrine Maiden', value: 'shrine maiden, miko' },
            { label: 'è­·å£«', en: 'Nurse', value: 'nurse, hospital' },
            { label: 'é¨å£«', en: 'Knight', value: 'knight, armor, sword' },
            { label: 'ä¿®å¥³', en: 'Nun', value: 'nun, habit' },
            { label: 'å¿è€…', en: 'Ninja', value: 'ninja, shinobi' },
            { label: 'é­”æ³•å¸«', en: 'Mage', value: 'mage, wizard, robe, staff' },
            { label: 'ç‰§å¸«', en: 'Cleric', value: 'cleric, priest, healer' },
            { label: 'å¶åƒ', en: 'Idol', value: 'idol, stage outfit, microphone' },
            { label: 'é­”ç‹', en: 'Demon Lord', value: 'demon lord, dark power' },
            { label: 'æ®ºæ‰‹', en: 'Assassin', value: 'assassin, dark clothes' },
            { label: 'ç›œè³Š', en: 'Rogue', value: 'thief, rogue, dagger' },
            { label: 'é‹å‹•å“¡', en: 'Athlete', value: 'athlete, sportswear' },
            { label: 'è³½è»Šæ‰‹', en: 'Racer', value: 'racer, racing suit' },
            { label: 'å»šå¸«', en: 'Chef', value: 'chef, apron' },
            { label: 'å¤ªç©ºäºº', en: 'Astronaut', value: 'astronaut, spacesuit' },
            { label: 'è»äºº', en: 'Soldier', value: 'soldier, military' },
            { label: 'è­¦å¯Ÿ', en: 'Police', value: 'police officer, uniform' },
            { label: 'æ¨¡ç‰¹å…’', en: 'Model', value: 'model, fashion, runway' },
            { label: 'ç©ºå§', en: 'Flight Att.', value: 'flight attendant, uniform' },
            { label: 'æ•™å¸«', en: 'Teacher', value: 'teacher, glasses, classroom' },
            { label: 'åœ–æ›¸é¤¨å“¡', en: 'Librarian', value: 'librarian, glasses, books' }
        ];

        // ============================================
        // UNIVERSAL CONFLICT RULES
        // ============================================
        // Each rule: { a: categoryA, b: categoryB, keyword_a, keyword_b, reason }
        //
        // HOW TO ADD NEW CONFLICTS:
        //   1. Just add a new entry to this array.
        //   2. No other code changes needed.
        //   3. Works for ANY category: race, job, outfit, accessories, scene, pose, etc.
        //
        const CONFLICT_RULES = [
            // â”€â”€ ç¨®æ— â†” è·æ¥­ â”€â”€
            { a: 'race', b: 'job', keyword_a: 'vampire', keyword_b: 'shrine maiden', reason: 'ğŸ§› ç¥è–åŠ›é‡èˆ‡é—‡é»‘å­˜åœ¨ç›¸äº’æ’æ–¥' },
            { a: 'race', b: 'job', keyword_a: 'vampire', keyword_b: 'nun', reason: 'ğŸ§› ç¥è–åŠ›é‡èˆ‡é—‡é»‘å­˜åœ¨ç›¸äº’æ’æ–¥' },
            { a: 'race', b: 'job', keyword_a: 'vampire', keyword_b: 'cleric', reason: 'ğŸ§› ç¥è–åŠ›é‡èˆ‡é—‡é»‘å­˜åœ¨ç›¸äº’æ’æ–¥' },

            { a: 'race', b: 'job', keyword_a: 'demon', keyword_b: 'shrine maiden', reason: 'ğŸ‘¹ è–é‚ªå°ç«‹ï¼Œå…‰æ˜èˆ‡é»‘æš—ä¸å…±æˆ´å¤©' },
            { a: 'race', b: 'job', keyword_a: 'demon', keyword_b: 'nun', reason: 'ğŸ‘¹ è–é‚ªå°ç«‹ï¼Œå…‰æ˜èˆ‡é»‘æš—ä¸å…±æˆ´å¤©' },
            { a: 'race', b: 'job', keyword_a: 'demon', keyword_b: 'cleric', reason: 'ğŸ‘¹ è–é‚ªå°ç«‹ï¼Œå…‰æ˜èˆ‡é»‘æš—ä¸å…±æˆ´å¤©' },
            { a: 'race', b: 'job', keyword_a: 'demon', keyword_b: 'knight', reason: 'ğŸ‘¹ è–é‚ªå°ç«‹ï¼Œå…‰æ˜èˆ‡é»‘æš—ä¸å…±æˆ´å¤©' },

            { a: 'race', b: 'job', keyword_a: 'angel', keyword_b: 'demon lord', reason: 'ğŸ˜‡ å–„èˆ‡æƒ¡çš„åŠ›é‡äº’ç›¸çŸ›ç›¾' },
            { a: 'race', b: 'job', keyword_a: 'angel', keyword_b: 'assassin', reason: 'ğŸ˜‡ å–„èˆ‡æƒ¡çš„åŠ›é‡äº’ç›¸çŸ›ç›¾' },
            { a: 'race', b: 'job', keyword_a: 'angel', keyword_b: 'thief', reason: 'ğŸ˜‡ å–„èˆ‡æƒ¡çš„åŠ›é‡äº’ç›¸çŸ›ç›¾' },

            { a: 'race', b: 'job', keyword_a: 'ghost', keyword_b: 'athlete', reason: 'ğŸ‘» éå¯¦é«”å­˜åœ¨ç„¡æ³•é€²è¡Œç‰©ç†æ´»å‹•' },
            { a: 'race', b: 'job', keyword_a: 'ghost', keyword_b: 'racer', reason: 'ğŸ‘» éå¯¦é«”å­˜åœ¨ç„¡æ³•é€²è¡Œç‰©ç†æ´»å‹•' },
            { a: 'race', b: 'job', keyword_a: 'ghost', keyword_b: 'chef', reason: 'ğŸ‘» éå¯¦é«”å­˜åœ¨ç„¡æ³•é€²è¡Œç‰©ç†æ´»å‹•' },

            { a: 'race', b: 'job', keyword_a: 'mermaid', keyword_b: 'knight', reason: 'ğŸ§œ é­šå°¾ç„¡æ³•å¥”è·‘æˆ–ç©¿è‘—é™¸åœ°è£å‚™' },
            { a: 'race', b: 'job', keyword_a: 'mermaid', keyword_b: 'ninja', reason: 'ğŸ§œ é­šå°¾ç„¡æ³•å¥”è·‘æˆ–ç©¿è‘—é™¸åœ°è£å‚™' },
            { a: 'race', b: 'job', keyword_a: 'mermaid', keyword_b: 'racer', reason: 'ğŸ§œ é­šå°¾ç„¡æ³•å¥”è·‘æˆ–ç©¿è‘—é™¸åœ°è£å‚™' },

            { a: 'race', b: 'job', keyword_a: 'android', keyword_b: 'mage', reason: 'ğŸ¤– ç§‘æŠ€å­˜åœ¨èˆ‡é­”æ³•ç³»çµ±äº’ç›¸æ’æ–¥' },
            { a: 'race', b: 'job', keyword_a: 'android', keyword_b: 'cleric', reason: 'ğŸ¤– ç§‘æŠ€å­˜åœ¨èˆ‡é­”æ³•ç³»çµ±äº’ç›¸æ’æ–¥' },
            { a: 'race', b: 'job', keyword_a: 'android', keyword_b: 'shrine maiden', reason: 'ğŸ¤– ç§‘æŠ€å­˜åœ¨èˆ‡é­”æ³•ç³»çµ±äº’ç›¸æ’æ–¥' },

            { a: 'race', b: 'job', keyword_a: 'slime', keyword_b: 'knight', reason: 'ğŸ«  ç„¡å›ºå®šå½¢é«”é›£ä»¥ç©¿è‘—åˆ¶æœè£å‚™' },
            { a: 'race', b: 'job', keyword_a: 'slime', keyword_b: 'soldier', reason: 'ğŸ«  ç„¡å›ºå®šå½¢é«”é›£ä»¥ç©¿è‘—åˆ¶æœè£å‚™' },
            { a: 'race', b: 'job', keyword_a: 'slime', keyword_b: 'police officer', reason: 'ğŸ«  ç„¡å›ºå®šå½¢é«”é›£ä»¥ç©¿è‘—åˆ¶æœè£å‚™' },

            { a: 'race', b: 'job', keyword_a: 'fairy', keyword_b: 'soldier', reason: 'ğŸ§š è¿·ä½ é«”å‹ç„¡æ³•æ“ä½œäººé¡å°ºå¯¸è£å‚™' },
            { a: 'race', b: 'job', keyword_a: 'fairy', keyword_b: 'police officer', reason: 'ğŸ§š è¿·ä½ é«”å‹ç„¡æ³•æ“ä½œäººé¡å°ºå¯¸è£å‚™' },
            { a: 'race', b: 'job', keyword_a: 'fairy', keyword_b: 'astronaut', reason: 'ğŸ§š è¿·ä½ é«”å‹ç„¡æ³•æ“ä½œäººé¡å°ºå¯¸è£å‚™' },

            { a: 'race', b: 'job', keyword_a: 'dragon', keyword_b: 'nun', reason: 'ğŸ‰ é¾æ—å¤–è§€èˆ‡æº«å’Œè·æ¥­è¦–è¦ºå·®ç•°å·¨å¤§' },
            { a: 'race', b: 'job', keyword_a: 'dragon', keyword_b: 'teacher', reason: 'ğŸ‰ é¾æ—å¤–è§€èˆ‡æº«å’Œè·æ¥­è¦–è¦ºå·®ç•°å·¨å¤§' },
            { a: 'race', b: 'job', keyword_a: 'dragon', keyword_b: 'librarian', reason: 'ğŸ‰ é¾æ—å¤–è§€èˆ‡æº«å’Œè·æ¥­è¦–è¦ºå·®ç•°å·¨å¤§' },

            // â”€â”€ æœªä¾†æ“´å……ï¼ˆåªéœ€åŠ é€™è£¡ï¼Œä¸ç”¨æ”¹å…¶ä»–ç¨‹å¼ç¢¼ï¼‰ â”€â”€
            // { a: 'job',  b: 'outfit',      keyword_a: 'knight', keyword_b: 'bikini',  reason: 'âš”ï¸ å…¨èº«ç”²å†‘èˆ‡æ³³è£ç„¡æ³•å…±å­˜' },
            // { a: 'race', b: 'accessories', keyword_a: 'mermaid', keyword_b: 'boots',   reason: 'ğŸ§œ é­šå°¾ç„¡æ³•ç©¿é´å­' },
            // { a: 'race', b: 'outfit',      keyword_a: 'ghost',   keyword_b: 'armor',   reason: 'ğŸ‘» éå¯¦é«”ç„¡æ³•ç©¿æˆ´é‡ç”²' },
        ];

        // Category display labels (auto-used by modal & status)
        const CATEGORY_LABELS = {
            race: { zh: 'ç¨®æ—', en: 'Race' },
            job: { zh: 'è·æ¥­', en: 'Job' },
            outfit: { zh: 'æœé£¾', en: 'Outfit' },
            accessories: { zh: 'é…ä»¶', en: 'Accessories' },
            expression: { zh: 'è¡¨æƒ…', en: 'Expression' },
            scene: { zh: 'å ´æ™¯', en: 'Scene' },
            pose: { zh: 'å§¿å‹¢', en: 'Pose' },
            bodyType: { zh: 'èº«æ', en: 'Body Type' },
            hairstyle: { zh: 'é«®å‹', en: 'Hairstyle' },
        };

        // ============================
        // STATE (universal)
        // ============================
        // selections[category] = { label, en, value }
        const selections = {};
        let currentResolution = null;
        let conflictInfo = null; // { rule, labelA, labelB, catA, catB, reason }
        let warningCount = 0;
        let warningsEnabled = true;
        let autoResolution = null;
        let alarmOscillators = [];

        // ============================
        // AUDIO â€” Bank Vault Alarm
        // ============================
        let audioCtx = null;

        function playVaultAlarm() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const c = audioCtx, t = c.currentTime;
                const master = c.createGain();
                master.gain.value = 0.28;
                master.connect(c.destination);
                stopAlarm();

                // 1. Impact boom
                const impact = c.createOscillator();
                const impG = c.createGain();
                impact.type = 'sine';
                impact.frequency.setValueAtTime(100, t);
                impact.frequency.exponentialRampToValueAtTime(25, t + 0.4);
                impG.gain.setValueAtTime(0.7, t);
                impG.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
                impact.connect(impG); impG.connect(master);
                impact.start(t); impact.stop(t + 0.45);

                // Metal clang
                const clangSize = c.sampleRate * 0.15;
                const clangBuf = c.createBuffer(1, clangSize, c.sampleRate);
                const clangData = clangBuf.getChannelData(0);
                for (let i = 0; i < clangSize; i++) {
                    clangData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / clangSize, 2);
                }
                const clang = c.createBufferSource();
                clang.buffer = clangBuf;
                const clangFilter = c.createBiquadFilter();
                clangFilter.type = 'bandpass';
                clangFilter.frequency.value = 2500;
                clangFilter.Q.value = 5;
                const clangG = c.createGain();
                clangG.gain.value = 0.35;
                clang.connect(clangFilter);
                clangFilter.connect(clangG);
                clangG.connect(master);
                clang.start(t);

                // 2. Repeating siren
                const sirenDuration = 3.0, burstLen = 0.12, gap = 0.06, cycle = burstLen + gap;
                for (let i = 0; i * cycle < sirenDuration; i++) {
                    const st = t + 0.2 + i * cycle;
                    const freq = i % 2 === 0 ? 880 : 660;
                    const siren = c.createOscillator();
                    const sirenG = c.createGain();
                    siren.type = 'square';
                    siren.frequency.setValueAtTime(freq, st);
                    sirenG.gain.setValueAtTime(0.18, st);
                    sirenG.gain.setValueAtTime(0.18, st + burstLen * 0.8);
                    sirenG.gain.exponentialRampToValueAtTime(0.001, st + burstLen);
                    siren.connect(sirenG); sirenG.connect(master);
                    siren.start(st); siren.stop(st + burstLen + 0.01);
                    alarmOscillators.push(siren);
                }

                // 3. Sub-bass pulse
                for (let i = 0; i < 6; i++) {
                    const ps = t + 0.2 + i * 0.5;
                    const pulse = c.createOscillator();
                    const pulseG = c.createGain();
                    pulse.type = 'sine'; pulse.frequency.value = 45;
                    pulseG.gain.setValueAtTime(0.3, ps);
                    pulseG.gain.exponentialRampToValueAtTime(0.001, ps + 0.25);
                    pulse.connect(pulseG); pulseG.connect(master);
                    pulse.start(ps); pulse.stop(ps + 0.3);
                    alarmOscillators.push(pulse);
                }
            } catch (e) { }
        }

        function stopAlarm() {
            alarmOscillators.forEach(o => { try { o.stop(); } catch (e) { } });
            alarmOscillators = [];
        }

        function playResolveSound() {
            try {
                stopAlarm();
                if (!audioCtx) return;
                const c = audioCtx, t = c.currentTime;
                const m = c.createGain(); m.gain.value = 0.15; m.connect(c.destination);
                [659.25, 783.99, 1046.5].forEach((f, i) => {
                    const o = c.createOscillator(), g = c.createGain();
                    o.type = 'sine'; o.frequency.value = f;
                    g.gain.setValueAtTime(0.2, t + i * 0.08);
                    g.gain.exponentialRampToValueAtTime(0.001, t + i * 0.08 + 0.3);
                    o.connect(g); g.connect(m);
                    o.start(t + i * 0.08); o.stop(t + i * 0.08 + 0.35);
                });
            } catch (e) { }
        }

        // ============================================
        // UNIVERSAL CONFLICT DETECTION
        // ============================================
        // Scans ALL current selections against ALL rules.
        // Returns first match or null.
        function checkAllConflicts() {
            for (const rule of CONFLICT_RULES) {
                const selA = selections[rule.a];
                const selB = selections[rule.b];
                if (!selA || !selB) continue;

                if (selA.value.includes(rule.keyword_a) && selB.value.includes(rule.keyword_b)) {
                    return {
                        rule,
                        labelA: selA.label,
                        labelB: selB.label,
                        catA: rule.a,
                        catB: rule.b,
                        reason: rule.reason,
                    };
                }
            }
            return null;
        }

        // Called after any selection change in any category
        function onSelectionChanged() {
            currentResolution = null;
            updateStatus();

            const conflict = checkAllConflicts();
            if (conflict) {
                conflictInfo = conflict;

                // Auto-resolve silently if enabled
                if (!warningsEnabled && autoResolution) {
                    currentResolution = autoResolution;
                    updateStatus();
                    generatePrompt();
                    showToast(`âš¡ å·²è‡ªå‹•å¥—ç”¨: ${getResolutionLabel(autoResolution)}`);
                    return;
                }

                warningCount++;
                showConflictModal();
            } else {
                conflictInfo = null;
                generatePrompt();
            }
        }

        // ============================
        // UI RENDERING (generic)
        // ============================
        function renderGrid(containerId, items, category) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'tag-btn';
                btn.textContent = `${item.label} ${item.en}`;
                btn.dataset.value = item.value;

                if (selections[category] && selections[category].value === item.value) {
                    btn.classList.add('active');
                }

                btn.addEventListener('click', () => {
                    selections[category] = item;
                    renderGrid(containerId, items, category);
                    onSelectionChanged();
                });

                container.appendChild(btn);
            });
        }

        function getResolutionLabel(type) {
            if (type === 'ignore') return 'ğŸ”¥ å¿½ç•¥è­¦å‘Š';
            if (type === 'dual') return 'ğŸ‘¥ é›™äººæ§‹åœ–';
            if (type === 'merge') return 'âœ¨ åˆä½µä¸€é«”';
            return 'â€”';
        }

        function getCategoryLabel(cat) {
            const c = CATEGORY_LABELS[cat];
            return c ? c.zh : cat;
        }

        function updateStatus() {
            document.getElementById('status-race').textContent =
                selections.race ? `${selections.race.label} (${selections.race.en})` : 'æœªé¸æ“‡';
            document.getElementById('status-job').textContent =
                selections.job ? `${selections.job.label} (${selections.job.en})` : 'æœªé¸æ“‡';
            document.getElementById('status-count').textContent = warningCount;

            const conflictEl = document.getElementById('status-conflict');
            if (conflictInfo) {
                conflictEl.textContent = 'âš ï¸ è¡çªï¼';
                conflictEl.style.color = '#ff4444';
            } else {
                conflictEl.textContent = 'âœ… ç„¡';
                conflictEl.style.color = '#44ff88';
            }

            const resEl = document.getElementById('status-resolution');
            resEl.textContent = getResolutionLabel(currentResolution) || 'â€”';
            if (currentResolution === 'ignore') resEl.style.color = '#ff8844';
            else if (currentResolution === 'dual') resEl.style.color = '#44aaff';
            else if (currentResolution === 'merge') resEl.style.color = '#44ff88';
            else resEl.style.color = '#bb86fc';

            updateSettingsUI();
        }

        // ============================
        // CONFLICT MODAL (generic)
        // ============================
        function showConflictModal() {
            // Generic: uses conflictInfo.labelA/B and catA/B
            document.getElementById('combo-a').textContent = conflictInfo.labelA;
            document.getElementById('combo-b').textContent = conflictInfo.labelB;
            document.getElementById('conflict-reason').textContent = conflictInfo.reason;
            document.getElementById('conflict-desc').innerHTML =
                `ã€Œ<strong>${conflictInfo.labelA}</strong>ã€Ã—ã€Œ<strong>${conflictInfo.labelB}</strong>ã€çµ„åˆåµæ¸¬åˆ°è¡çªï¼`;

            document.getElementById('conflict-counter').textContent = `ç¬¬ ${warningCount} æ¬¡è­¦å‘Š`;

            const rememberEl = document.getElementById('remember-choice');
            const rememberCb = document.getElementById('remember-checkbox');
            if (warningCount >= 3) {
                rememberEl.classList.add('visible');
            } else {
                rememberEl.classList.remove('visible');
            }
            rememberCb.checked = false;

            // Screen flash
            const flash = document.getElementById('screen-flash');
            flash.classList.remove('active');
            void flash.offsetWidth;
            flash.classList.add('active');

            // Screen shake
            document.body.classList.remove('screen-shake');
            void document.body.offsetWidth;
            document.body.classList.add('screen-shake');

            // Show modal
            const overlay = document.getElementById('conflict-overlay');
            overlay.classList.add('active');
            const modal = overlay.querySelector('.conflict-modal');
            modal.style.animation = 'none';
            void modal.offsetWidth;
            modal.style.animation = '';

            playVaultAlarm();
        }

        function hideConflictModal() {
            document.getElementById('conflict-overlay').classList.remove('active');
        }

        // ============================
        // RESOLUTION
        // ============================
        function resolve(type) {
            currentResolution = type;

            const rememberCb = document.getElementById('remember-checkbox');
            if (rememberCb.checked) {
                autoResolution = type;
                warningsEnabled = false;
            }

            hideConflictModal();
            playResolveSound();

            let toastMsg = '';
            if (type === 'ignore') toastMsg = 'ğŸ”¥ å·²å¿½ç•¥è­¦å‘Š â€” ä¿ç•™åŸå§‹è¨­å®šï¼Œå¯èƒ½ç”Ÿæˆé›™è§’è‰²';
            else if (type === 'dual') toastMsg = 'ğŸ‘¥ å·²åˆ‡æ›ç‚ºé›™äººæ§‹åœ– â€” åŠ å…¥ "2characters" æç¤ºè©';
            else if (type === 'merge') toastMsg = 'âœ¨ å·²åˆä½µç‚ºä¸€é«” â€” å¼·èª¿å–®ä¸€è§’è‰²æ“æœ‰é›™é‡ç‰¹è³ª';

            if (rememberCb.checked) {
                toastMsg += '\nğŸ“Œ å·²è¨˜ä½æ­¤é¸æ“‡ï¼Œå¾ŒçºŒè¡çªå°‡è‡ªå‹•å¥—ç”¨';
            }

            showToast(toastMsg);
            updateStatus();
            generatePrompt();
        }

        function showToast(msg) {
            const toast = document.getElementById('resolution-toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3500);
        }

        // ============================
        // SETTINGS
        // ============================
        function updateSettingsUI() {
            const autoModeEl = document.getElementById('setting-auto-mode');
            document.getElementById('setting-warnings-enabled').checked = warningsEnabled;
            autoModeEl.textContent = autoResolution
                ? getResolutionLabel(autoResolution)
                : 'æœªè¨­å®šï¼ˆæ¯æ¬¡è©¢å•ï¼‰';
        }

        document.getElementById('setting-warnings-enabled').addEventListener('change', (e) => {
            warningsEnabled = e.target.checked;
            if (warningsEnabled) autoResolution = null;
            updateSettingsUI();
            showToast(warningsEnabled ? 'âœ… è¡çªè­¦å‘Šå·²é‡æ–°é–‹å•Ÿ' : 'ğŸ”‡ è¡çªè­¦å‘Šå·²é—œé–‰');
        });

        document.getElementById('setting-reset-auto').addEventListener('click', () => {
            autoResolution = null;
            warningsEnabled = true;
            warningCount = 0;
            updateSettingsUI();
            document.getElementById('setting-warnings-enabled').checked = true;
            showToast('ğŸ”„ å·²é‡ç½®è¡çªè¨­å®š â€” æ¯æ¬¡è¡çªéƒ½æœƒè©¢å•');
        });

        // ============================
        // PROMPT GENERATION (generic)
        // ============================
        function generatePrompt() {
            const output = document.getElementById('prompt-output');
            const allValues = Object.values(selections).map(s => s.value);

            if (allValues.length === 0) {
                output.textContent = 'ï¼ˆé¸æ“‡å¾Œè‡ªå‹•ç”Ÿæˆ promptï¼‰';
                return;
            }

            const base = `female, ${allValues.join(', ')}`;

            if (!conflictInfo || !currentResolution || currentResolution === 'ignore') {
                output.textContent = base;
            } else if (currentResolution === 'dual') {
                output.textContent = `2characters, multiple characters, ${base}`;
            } else if (currentResolution === 'merge') {
                const coreA = selections[conflictInfo.catA]?.value.split(',')[0].trim() || '';
                const coreB = selections[conflictInfo.catB]?.value.split(',')[0].trim() || '';
                output.textContent = `(${coreA} ${coreB}:1.3), single character, solo, ${base}`;
            }
        }

        // ============================
        // INIT
        // ============================
        renderGrid('race-grid', RACES, 'race');
        renderGrid('job-grid', JOBS, 'job');
        updateSettingsUI();
    </script>
</body>

</html>