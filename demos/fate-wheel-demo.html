<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹å‘½ã®è¼ªç›¤ â€” ç‰¹æ•ˆ Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: #0a0a12;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        h1 {
            margin-top: 2rem;
            font-size: 1.6rem;
            color: #fbbf24;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .demo-description {
            color: #888;
            font-size: 0.9rem;
            margin: 0.5rem 0 2rem;
        }

        /* === ä¸»å®¹å™¨ === */
        .stage {
            position: relative;
            width: 700px;
            max-width: 95vw;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        /* === è¼ªç›¤æŒ‰éˆ• === */
        .fate-btn-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .fate-btn {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 36px;
            font-size: 1.1rem;
            font-weight: 700;
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.08);
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
        }

        .fate-btn:hover {
            background: rgba(251, 191, 36, 0.15);
            box-shadow: 0 0 25px rgba(251, 191, 36, 0.2);
        }

        .fate-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .fate-btn .wheel-icon {
            font-size: 1.4rem;
            transition: none;
        }

        /* Phase 1: æ—‹è½‰å‹•ç•« */
        .fate-btn.spinning .wheel-icon {
            animation: wheelSpin 2.5s cubic-bezier(0.2, 0.8, 0.3, 1) forwards;
        }

        @keyframes wheelSpin {
            0% {
                transform: rotate(0deg);
            }

            20% {
                transform: rotate(360deg);
            }

            40% {
                transform: rotate(1080deg);
            }

            60% {
                transform: rotate(2160deg);
            }

            80% {
                transform: rotate(3000deg);
            }

            100% {
                transform: rotate(3240deg);
            }
        }

        /* Phase 1: æŒ‰éˆ•è„ˆè¡é‚Šæ¡† */
        .fate-btn.spinning {
            border-color: rgba(251, 191, 36, 0.8);
            animation: btnPulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes btnPulse {
            from {
                box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
            }

            to {
                box-shadow: 0 0 35px rgba(251, 191, 36, 0.5), 0 0 60px rgba(168, 85, 247, 0.3);
            }
        }

        /* === Phase 2: é–ƒå…‰ Overlay === */
        .flash-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at var(--flash-x, 50%) var(--flash-y, 50%),
                    rgba(251, 191, 36, 0.9),
                    rgba(168, 85, 247, 0.4) 40%,
                    transparent 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .flash-overlay.active {
            animation: flashBurst 0.6s ease-out forwards;
        }

        @keyframes flashBurst {
            0% {
                opacity: 1;
                transform: scale(0.8);
            }

            30% {
                opacity: 0.8;
                transform: scale(1.2);
            }

            100% {
                opacity: 0;
                transform: scale(2);
            }
        }

        /* === Phase 2: ç•«é¢éœ‡å‹• === */
        .shake {
            animation: screenShake 0.4s ease-out;
        }

        @keyframes screenShake {
            0% {
                transform: translate(0, 0);
            }

            10% {
                transform: translate(-6px, 3px);
            }

            20% {
                transform: translate(5px, -4px);
            }

            30% {
                transform: translate(-4px, 5px);
            }

            40% {
                transform: translate(4px, -2px);
            }

            50% {
                transform: translate(-3px, 3px);
            }

            60% {
                transform: translate(2px, -2px);
            }

            70% {
                transform: translate(-1px, 1px);
            }

            100% {
                transform: translate(0, 0);
            }
        }

        /* === Phase 3: é¸é …å¡«å…¥ === */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .section-slot {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            opacity: 0.3;
            transition: all 0.3s;
        }

        .section-slot .slot-label {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-slot .slot-value {
            font-size: 0.95rem;
            color: #555;
            font-weight: 600;
            min-height: 1.4em;
        }

        /* å¡«å…¥å‹•ç•« */
        .section-slot.filled {
            opacity: 1;
            border-color: rgba(168, 85, 247, 0.4);
            background: rgba(168, 85, 247, 0.08);
            animation: slotReveal 0.4s ease-out;
        }

        .section-slot.filled .slot-value {
            color: #c084fc;
        }

        @keyframes slotReveal {
            0% {
                transform: scale(0.85);
                opacity: 0;
                border-color: rgba(251, 191, 36, 0.8);
            }

            50% {
                transform: scale(1.05);
                border-color: rgba(251, 191, 36, 0.5);
            }

            100% {
                transform: scale(1);
                opacity: 1;
                border-color: rgba(168, 85, 247, 0.4);
            }
        }

        /* ç¶­åº¦çµæœ */
        .dimension-result {
            text-align: center;
            margin-bottom: 1.5rem;
            min-height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dimension-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 24px;
            border-radius: 20px;
            font-size: 1.1rem;
            font-weight: 700;
            opacity: 0;
            transform: scale(0);
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .dimension-badge.show {
            opacity: 1;
            transform: scale(1);
        }

        .dimension-badge.anime {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.3), rgba(168, 85, 247, 0.3));
            color: #f472b6;
            border: 1px solid rgba(236, 72, 153, 0.5);
            box-shadow: 0 0 20px rgba(236, 72, 153, 0.2);
        }

        .dimension-badge.realistic {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(34, 197, 94, 0.3));
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .dimension-badge.fantasy {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.3), rgba(251, 191, 36, 0.3));
            color: #c084fc;
            border: 1px solid rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.2);
        }

        .dimension-badge.d25 {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(59, 130, 246, 0.3));
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
        }

        /* === æ™‚é–“è»¸æŒ‡ç¤ºå™¨ === */
        .timeline {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            font-size: 0.8rem;
            color: #666;
        }

        .timeline-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 4px 0;
            transition: color 0.3s;
        }

        .timeline-step.active {
            color: #fbbf24;
        }

        .timeline-step.done {
            color: #4ade80;
        }

        .timeline-step .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #333;
            transition: all 0.3s;
        }

        .timeline-step.active .dot {
            background: #fbbf24;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
        }

        .timeline-step.done .dot {
            background: #4ade80;
        }

        /* === æ³¢ç´‹æ•ˆæœ === */
        .ripple {
            position: fixed;
            border-radius: 50%;
            border: 2px solid rgba(251, 191, 36, 0.6);
            pointer-events: none;
            z-index: 9998;
            opacity: 0;
        }

        .ripple.active {
            animation: rippleExpand 1s ease-out forwards;
        }

        @keyframes rippleExpand {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }

            100% {
                width: 600px;
                height: 600px;
                opacity: 0;
                margin-left: -300px;
                margin-top: -300px;
            }
        }
    </style>
</head>

<body>

    <h1>ğŸ¡ é‹å‘½ã®è¼ªç›¤ â€” ç‰¹æ•ˆ Demo</h1>
    <p class="demo-description">é»æ“ŠæŒ‰éˆ•é«”é©—ä¸‰éšæ®µå‹•ç•« + éŸ³æ•ˆ</p>

    <div class="stage" id="stage">
        <!-- Fate æŒ‰éˆ• -->
        <div class="fate-btn-container">
            <button class="fate-btn" id="fate-btn">
                <i class="fa-solid fa-dharmachakra wheel-icon" id="wheel-icon"></i>
                <span>é‹å‘½ã®è¼ªç›¤</span>
            </button>
        </div>

        <!-- ç¶­åº¦çµæœ -->
        <div class="dimension-result">
            <div class="dimension-badge" id="dim-badge"></div>
        </div>

        <!-- é¸é …æ ¼å­ -->
        <div class="sections-grid" id="sections-grid"></div>

        <!-- æ™‚é–“è»¸ -->
        <div class="timeline" id="timeline">
            <div class="timeline-step" id="tl-1"><span class="dot"></span> Phase 1ï¼šè¼ªç›¤æ—‹è½‰ + å¼•æ“éŸ³ï¼ˆ0~2.5sï¼‰</div>
            <div class="timeline-step" id="tl-2"><span class="dot"></span> Phase 2ï¼šé–ƒå…‰ + éœ‡å‹• + è¡æ“ŠéŸ³ï¼ˆ2.5sï¼‰</div>
            <div class="timeline-step" id="tl-3"><span class="dot"></span> Phase 3ï¼šé¸é …é€è¡Œå¡«å…¥ + blip éŸ³ï¼ˆ2.8~4.5sï¼‰</div>
            <div class="timeline-step" id="tl-4"><span class="dot"></span> å®Œæˆï¼šå‹åˆ©å’Œå¼¦ï¼ˆ4.5sï¼‰</div>
        </div>
    </div>

    <!-- Flash Overlay -->
    <div class="flash-overlay" id="flash-overlay"></div>

    <script>
        // ============================
        // æ¨¡æ“¬è³‡æ–™
        // ============================
        const SECTIONS = [
            { id: 'dimension', label: 'æ¬¡å…ƒ', options: ['äºŒæ¬¡å…ƒ', 'å¯«å¯¦', 'å¹»æƒ³æ··åˆ', '2.5D'] },
            { id: 'gender', label: 'æ€§åˆ¥', options: ['ç”·æ€§', 'å¥³æ€§'] },
            { id: 'age', label: 'å¹´é½¡', options: ['14æ­²', '18æ­²', '21æ­²', '25æ­²', '30æ­²', '35æ­²'] },
            { id: 'race', label: 'ç¨®æ—', options: ['äººé¡', 'ç²¾éˆ', 'åŠç¸äºº', 'å¤©ä½¿', 'æƒ¡é­”', 'å¸è¡€é¬¼', 'é¾äºº'] },
            { id: 'job', label: 'è·æ¥­', options: ['å­¸ç”Ÿ', 'é¨å£«', 'é­”æ³•å¸«', 'åˆºå®¢', 'ç‰§å¸«', 'é†«ç”Ÿ', 'æˆ°å£«'] },
            { id: 'hairstyle', label: 'é«®å‹', options: ['é•·é«®', 'çŸ­é«®', 'é¦¬å°¾', 'é›™é¦¬å°¾', 'å¯¸é ­', 'æ²¹é ­', 'çˆ†ç‚¸é ­'] },
            { id: 'bodyType', label: 'èº«æ', options: ['æ¨™æº–', 'ç²¾å£¯', 'çº–ç´°', 'è±è…´', 'å¬Œå°', 'é«˜å¤§'] },
            { id: 'outfit', label: 'æœè£', options: ['åˆ¶æœ', 'ç›”ç”²', 'å’Œæœ', 'æ´‹è£', 'è¥¿è£', 'é€£å¸½è¡«', 'æˆ°é¬¥æœ'] },
            { id: 'expression', label: 'è¡¨æƒ…', options: ['å¾®ç¬‘', 'å†·é…·', 'é©šè¨', 'å®³ç¾', 'æ†¤æ€’', 'æ‚²å‚·', 'é‚ªç¬‘'] },
            { id: 'pose', label: 'å§¿å‹¢', options: ['ç«™ç«‹', 'åå§¿', 'æˆ°é¬¥', 'å¥”è·‘', 'é£›è¡Œ', 'ä¸‹è·ª', 'å›çœ¸'] },
            { id: 'scene', label: 'å ´æ™¯', options: ['åŸå ¡', 'æ£®æ—', 'æµ·é‚Š', 'æ•™å®¤', 'æˆ°å ´', 'ç¥æ®¿', 'æ˜Ÿç©ºä¸‹'] },
            { id: 'quality', label: 'å“è³ª', options: ['masterpiece', 'best quality', 'ultra detailed'] },
        ];

        const DIM_MAP = {
            'anime': { label: 'ğŸ¨ äºŒæ¬¡å…ƒ', cls: 'anime' },
            'realistic': { label: 'ğŸ“· å¯«å¯¦', cls: 'realistic' },
            'fantasy': { label: 'ğŸ§™ å¹»æƒ³æ··åˆ', cls: 'fantasy' },
            '2.5d': { label: 'ğŸ§Š 2.5D', cls: 'd25' },
        };

        // ============================
        // DOM
        // ============================
        const fateBtn = document.getElementById('fate-btn');
        const grid = document.getElementById('sections-grid');
        const dimBadge = document.getElementById('dim-badge');
        const flashOverlay = document.getElementById('flash-overlay');
        const stage = document.getElementById('stage');

        // åˆå§‹åŒ–æ ¼å­
        SECTIONS.forEach(s => {
            const slot = document.createElement('div');
            slot.className = 'section-slot';
            slot.id = `slot-${s.id}`;
            slot.innerHTML = `<div class="slot-label">${s.label}</div><div class="slot-value" id="val-${s.id}">â€”</div>`;
            grid.appendChild(slot);
        });

        // ============================
        // éŸ³æ•ˆå¼•æ“ (Web Audio API)
        // ============================
        let audioCtx = null;
        let masterGain = null;

        function initAudio() {
            if (audioCtx) return;
            const AC = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AC();
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.35;
            masterGain.connect(audioCtx.destination);
        }

        // Phase 1 éŸ³æ•ˆï¼šå¼•æ“å•Ÿå‹•å—¡é³´ï¼ˆæ¼¸å‡ï¼‰
        function playSpinSound() {
            initAudio();
            const t = audioCtx.currentTime;
            const dur = 2.5;

            // ä½é »å—¡é³´
            const osc1 = audioCtx.createOscillator();
            const g1 = audioCtx.createGain();
            osc1.type = 'sawtooth';
            osc1.frequency.setValueAtTime(60, t);
            osc1.frequency.exponentialRampToValueAtTime(200, t + dur * 0.7);
            osc1.frequency.exponentialRampToValueAtTime(120, t + dur);
            g1.gain.setValueAtTime(0.05, t);
            g1.gain.linearRampToValueAtTime(0.25, t + dur * 0.5);
            g1.gain.linearRampToValueAtTime(0.15, t + dur * 0.8);
            g1.gain.exponentialRampToValueAtTime(0.01, t + dur);
            osc1.connect(g1);
            g1.connect(masterGain);
            osc1.start(t);
            osc1.stop(t + dur);

            // é«˜é »æ³›éŸ³ â€” åƒèƒ½é‡åœ¨è“„ç©
            const osc2 = audioCtx.createOscillator();
            const g2 = audioCtx.createGain();
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(300, t);
            osc2.frequency.exponentialRampToValueAtTime(800, t + dur * 0.7);
            osc2.frequency.exponentialRampToValueAtTime(600, t + dur);
            g2.gain.setValueAtTime(0.01, t);
            g2.gain.linearRampToValueAtTime(0.08, t + dur * 0.6);
            g2.gain.exponentialRampToValueAtTime(0.01, t + dur);
            osc2.connect(g2);
            g2.connect(masterGain);
            osc2.start(t);
            osc2.stop(t + dur);

            // ç¯€å¥æ€§å’”å—’ â€” æ¨¡æ“¬è½‰ç›¤é½’è¼ª
            for (let i = 0; i < 25; i++) {
                const clickTime = t + (i / 25) * dur;
                const interval = dur / 25;
                const oClick = audioCtx.createOscillator();
                const gClick = audioCtx.createGain();
                oClick.type = 'square';
                oClick.frequency.setValueAtTime(1200 + Math.random() * 400, clickTime);
                // è¶Šå¿«è¶Šå¯† â†’ æ¼¸å¤§
                const vol = 0.02 + (i / 25) * 0.06;
                gClick.gain.setValueAtTime(vol, clickTime);
                gClick.gain.exponentialRampToValueAtTime(0.001, clickTime + 0.02);
                oClick.connect(gClick);
                gClick.connect(masterGain);
                oClick.start(clickTime);
                oClick.stop(clickTime + 0.02);
            }
        }

        // Phase 2 éŸ³æ•ˆï¼šè¡æ“Šæ³¢çˆ†ç™¼
        function playImpactSound() {
            initAudio();
            const t = audioCtx.currentTime;

            // ä½é »æ’æ“Š
            const osc1 = audioCtx.createOscillator();
            const g1 = audioCtx.createGain();
            osc1.type = 'sine';
            osc1.frequency.setValueAtTime(80, t);
            osc1.frequency.exponentialRampToValueAtTime(30, t + 0.4);
            g1.gain.setValueAtTime(0.6, t);
            g1.gain.exponentialRampToValueAtTime(0.01, t + 0.4);
            osc1.connect(g1);
            g1.connect(masterGain);
            osc1.start(t);
            osc1.stop(t + 0.4);

            // é«˜é »çˆ†è£‚ â€” ç™½å™ªéŸ³
            const bufSize = audioCtx.sampleRate * 0.3;
            const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
            const data = buf.getChannelData(0);
            for (let i = 0; i < bufSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buf;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.setValueAtTime(2000, t);
            filter.frequency.exponentialRampToValueAtTime(500, t + 0.2);
            const gn = audioCtx.createGain();
            gn.gain.setValueAtTime(0.4, t);
            gn.gain.exponentialRampToValueAtTime(0.01, t + 0.25);
            noise.connect(filter);
            filter.connect(gn);
            gn.connect(masterGain);
            noise.start(t);

            // åè¡å…±é³´
            const osc2 = audioCtx.createOscillator();
            const g2 = audioCtx.createGain();
            osc2.type = 'triangle';
            osc2.frequency.setValueAtTime(400, t);
            osc2.frequency.exponentialRampToValueAtTime(100, t + 0.5);
            g2.gain.setValueAtTime(0.2, t + 0.05);
            g2.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
            osc2.connect(g2);
            g2.connect(masterGain);
            osc2.start(t);
            osc2.stop(t + 0.5);
        }

        // Phase 3 éŸ³æ•ˆï¼šæ¯å€‹é¸é …çš„ blip
        function playBlip(index, total) {
            initAudio();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = 'sine';
            // éŸ³é«˜éš¨ index é€æ¼¸ä¸Šå‡
            const freq = 600 + (index / total) * 800;
            osc.frequency.setValueAtTime(freq, t);
            osc.frequency.exponentialRampToValueAtTime(freq * 1.2, t + 0.03);
            g.gain.setValueAtTime(0.15, t);
            g.gain.exponentialRampToValueAtTime(0.001, t + 0.04);
            osc.connect(g);
            g.connect(masterGain);
            osc.start(t);
            osc.stop(t + 0.04);
        }

        // Phase 4 éŸ³æ•ˆï¼šå‹åˆ©å’Œå¼¦ï¼ˆç®¡é¢¨ç´ï¼‰
        function playVictory() {
            initAudio();
            const t = audioCtx.currentTime;
            [261.6, 329.6, 392, 523.25].forEach((f, i) => {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(f, t);
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(0.12, t + 0.3);
                g.gain.linearRampToValueAtTime(0.08, t + 0.8);
                g.gain.exponentialRampToValueAtTime(0.001, t + 1.5);
                osc.connect(g);
                g.connect(masterGain);
                osc.start(t);
                osc.stop(t + 1.5);

                // æ³›éŸ³
                const osc2 = audioCtx.createOscillator();
                const g2 = audioCtx.createGain();
                osc2.type = 'sine';
                osc2.frequency.setValueAtTime(f * 2, t + 0.1);
                g2.gain.setValueAtTime(0.03, t + 0.1);
                g2.gain.exponentialRampToValueAtTime(0.001, t + 1.3);
                osc2.connect(g2);
                g2.connect(masterGain);
                osc2.start(t + 0.1);
                osc2.stop(t + 1.3);
            });
        }

        // ============================
        // æ™‚é–“è»¸æ§åˆ¶
        // ============================
        function setTimeline(step, status) {
            const el = document.getElementById(`tl-${step}`);
            el.classList.remove('active', 'done');
            if (status) el.classList.add(status);
        }

        function resetTimeline() {
            for (let i = 1; i <= 4; i++) setTimeline(i, null);
        }

        // ============================
        // ä¸»æµç¨‹
        // ============================
        let isRunning = false;

        async function triggerFateWheel() {
            if (isRunning) return;
            isRunning = true;
            fateBtn.disabled = true;

            // é‡ç½®æ‰€æœ‰æ ¼å­
            SECTIONS.forEach(s => {
                const slot = document.getElementById(`slot-${s.id}`);
                const val = document.getElementById(`val-${s.id}`);
                slot.classList.remove('filled');
                val.textContent = 'â€”';
                val.style.color = '';
            });
            dimBadge.className = 'dimension-badge';
            dimBadge.textContent = '';
            resetTimeline();

            // ======== Phase 1: æ—‹è½‰ (0~2.5s) ========
            setTimeline(1, 'active');
            fateBtn.classList.add('spinning');
            playSpinSound();

            await sleep(2500);
            fateBtn.classList.remove('spinning');
            setTimeline(1, 'done');

            // ======== Phase 2: é–ƒå…‰ + éœ‡å‹• (2.5s) ========
            setTimeline(2, 'active');

            // å–å¾—æŒ‰éˆ•ä½ç½®ä¾†å®šä½é–ƒå…‰ä¸­å¿ƒ
            const btnRect = fateBtn.getBoundingClientRect();
            const cx = ((btnRect.left + btnRect.width / 2) / window.innerWidth) * 100;
            const cy = ((btnRect.top + btnRect.height / 2) / window.innerHeight) * 100;
            flashOverlay.style.setProperty('--flash-x', cx + '%');
            flashOverlay.style.setProperty('--flash-y', cy + '%');

            flashOverlay.classList.remove('active');
            void flashOverlay.offsetWidth; // force reflow
            flashOverlay.classList.add('active');

            // æ³¢ç´‹
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const ripple = document.createElement('div');
                    ripple.className = 'ripple';
                    ripple.style.left = btnRect.left + btnRect.width / 2 + 'px';
                    ripple.style.top = btnRect.top + btnRect.height / 2 + 'px';
                    document.body.appendChild(ripple);
                    requestAnimationFrame(() => ripple.classList.add('active'));
                    setTimeout(() => ripple.remove(), 1200);
                }, i * 150);
            }

            stage.classList.add('shake');
            playImpactSound();

            await sleep(500);
            stage.classList.remove('shake');
            setTimeline(2, 'done');

            // ======== Phase 3: é€è¡Œå¡«å…¥ (2.8~4.5s) ========
            setTimeline(3, 'active');

            // éš¨æ©Ÿé¸æ“‡ç¶­åº¦
            const dims = ['anime', 'realistic', 'fantasy', '2.5d'];
            const chosenDim = dims[Math.floor(Math.random() * dims.length)];
            const dimInfo = DIM_MAP[chosenDim];

            // å…ˆæ­ç¤ºç¶­åº¦
            dimBadge.textContent = dimInfo.label;
            dimBadge.className = `dimension-badge ${dimInfo.cls}`;
            setTimeout(() => dimBadge.classList.add('show'), 50);

            await sleep(300);

            // å¡«å…¥æ¯å€‹ section
            for (let i = 0; i < SECTIONS.length; i++) {
                const s = SECTIONS[i];
                const slot = document.getElementById(`slot-${s.id}`);
                const val = document.getElementById(`val-${s.id}`);

                const chosen = s.options[Math.floor(Math.random() * s.options.length)];
                val.textContent = chosen;
                slot.classList.add('filled');
                playBlip(i, SECTIONS.length);

                await sleep(120); // 120ms é–“éš”
            }

            setTimeline(3, 'done');

            // ======== Phase 4: å‹åˆ©å’Œå¼¦ ========
            setTimeline(4, 'active');
            playVictory();
            await sleep(1500);
            setTimeline(4, 'done');

            // å®Œæˆ
            isRunning = false;
            fateBtn.disabled = false;
        }

        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        fateBtn.addEventListener('click', triggerFateWheel);
    </script>

</body>

</html>