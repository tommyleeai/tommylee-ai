<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È´òÁ¥öÈ≠îÊ≥ï Modal Demo v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .demo-trigger {
            padding: 16px 32px;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: #fff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-family: inherit;
            transition: all .3s;
            box-shadow: 0 4px 20px rgba(124, 58, 237, .4)
        }

        .demo-trigger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(124, 58, 237, .6)
        }

        /* === Race Magic Modal Overlay === */
        #race-magic-modal {
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, .85);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: rmm-fadeIn .4s ease
        }

        @keyframes rmm-fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        /* === ÈñÉÂÖâÁàÜÁôº === */
        .rmm-flash {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            background: radial-gradient(circle at 50% 50%, rgba(255, 255, 255, .8) 0%, rgba(168, 85, 247, .3) 30%, transparent 70%);
            animation: rmm-flash .6s ease-out forwards
        }

        @keyframes rmm-flash {
            0% {
                opacity: 1;
                transform: scale(.5)
            }

            50% {
                opacity: .6;
                transform: scale(1.2)
            }

            100% {
                opacity: 0;
                transform: scale(2)
            }
        }

        /* === ÊóãËΩâÈ≠îÊ≥ïÈô£ === */
        .rmm-magic-circle {
            position: absolute;
            width: 500px;
            height: 500px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 0;
            opacity: .1;
            animation: rmm-circleIn 1s ease-out, rmm-rotate 25s linear infinite
        }

        .rmm-magic-circle svg {
            width: 100%;
            height: 100%
        }

        @keyframes rmm-rotate {
            from {
                transform: translate(-50%, -50%) rotate(0deg)
            }

            to {
                transform: translate(-50%, -50%) rotate(360deg)
            }
        }

        @keyframes rmm-circleIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(.3) rotate(-90deg)
            }

            to {
                opacity: .1;
                transform: translate(-50%, -50%) scale(1) rotate(0deg)
            }
        }

        /* === Á≤íÂ≠ê === */
        .rmm-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden
        }

        .rmm-particle {
            position: absolute;
            border-radius: 50%;
            animation: rmm-sparkle linear infinite
        }

        @keyframes rmm-sparkle {
            0% {
                transform: translateY(100vh) scale(0);
                opacity: 0
            }

            10% {
                opacity: 1;
                transform: translateY(90vh) scale(1)
            }

            50% {
                opacity: .3
            }

            90% {
                opacity: .8
            }

            100% {
                transform: translateY(-10vh) scale(0);
                opacity: 0
            }
        }

        /* === ÊµÅÊòü === */
        .rmm-meteor {
            position: absolute;
            pointer-events: none;
            z-index: 0;
            width: 2px;
            height: 80px;
            background: linear-gradient(to bottom, rgba(251, 191, 36, 0), rgba(251, 191, 36, .7), rgba(251, 191, 36, 0));
            border-radius: 2px;
            animation: rmm-meteor linear forwards;
            opacity: 0
        }

        @keyframes rmm-meteor {
            0% {
                opacity: 0;
                transform: translate(0, 0) rotate(30deg)
            }

            10% {
                opacity: 1
            }

            90% {
                opacity: .7
            }

            100% {
                opacity: 0;
                transform: translate(-400px, 600px) rotate(30deg)
            }
        }

        /* === ContainerÔºàÂõ∫ÂÆöÈ´òÂ∫¶Ôºâ=== */
        .rmm-container {
            position: relative;
            z-index: 2;
            width: 92vw;
            max-width: 860px;
            height: 68vh;
            background: linear-gradient(135deg, rgba(15, 23, 42, .97), rgba(30, 41, 59, .97));
            border: 1px solid rgba(148, 163, 184, .15);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: rmm-containerIn .5s cubic-bezier(.34, 1.56, .64, 1);
            box-shadow: 0 0 50px rgba(124, 58, 237, .2), 0 0 100px rgba(124, 58, 237, .08)
        }

        @keyframes rmm-containerIn {
            from {
                opacity: 0;
                transform: scale(.5)
            }

            to {
                opacity: 1;
                transform: scale(1)
            }
        }

        /* === Header === */
        .rmm-header {
            padding: 16px 24px 12px;
            border-bottom: 1px solid rgba(148, 163, 184, .1);
            flex-shrink: 0
        }

        .rmm-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .rmm-title {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fbbf24, #a855f7, #7c3aed, #fbbf24);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rmm-titleGlow 3s ease infinite, rmm-titleIn .8s ease .3s both
        }

        @keyframes rmm-titleGlow {

            0%,
            100% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }
        }

        @keyframes rmm-titleIn {
            from {
                opacity: 0;
                filter: blur(8px)
            }

            to {
                opacity: 1;
                filter: blur(0)
            }
        }

        /* === Â∑•ÂÖ∑ÂàóÊåâÈàï === */
        .rmm-toolbar {
            display: flex;
            gap: 6px
        }

        .rmm-tool-btn {
            padding: 6px 12px;
            font-size: .72rem;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid rgba(148, 163, 184, .15);
            background: rgba(30, 41, 59, .6);
            color: #94a3b8;
            font-family: inherit;
            transition: all .2s;
            display: flex;
            align-items: center;
            gap: 4px
        }

        .rmm-tool-btn:hover {
            border-color: rgba(168, 85, 247, .4);
            color: #e2e8f0;
            background: rgba(124, 58, 237, .08)
        }

        .rmm-tool-btn.active {
            background: rgba(251, 191, 36, .1);
            border-color: #fbbf24;
            color: #fbbf24
        }

        .rmm-tool-btn .rmm-tool-icon {
            font-size: .85rem
        }

        /* === ÊêúÂ∞ãÊ°Ü === */
        .rmm-search-row {
            display: flex;
            gap: 8px;
            margin-top: 10px
        }

        .rmm-search-wrap {
            flex: 1;
            position: relative
        }

        .rmm-search {
            width: 100%;
            padding: 9px 16px 9px 36px;
            background: rgba(30, 41, 59, .8);
            border: 1px solid rgba(148, 163, 184, .2);
            border-radius: 10px;
            color: #e2e8f0;
            font-size: .82rem;
            font-family: inherit;
            outline: none;
            transition: border-color .3s
        }

        .rmm-search:focus {
            border-color: rgba(168, 85, 247, .5);
            box-shadow: 0 0 10px rgba(168, 85, 247, .12)
        }

        .rmm-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            font-size: .8rem
        }

        /* === ÂàÜÈ°û Tabs === */
        .rmm-tabs {
            display: flex;
            gap: 4px;
            padding: 10px 24px 0;
            overflow-x: auto;
            flex-shrink: 0
        }

        .rmm-tabs::-webkit-scrollbar {
            height: 0
        }

        .rmm-tab {
            padding: 7px 14px;
            font-size: .76rem;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            border: 1px solid rgba(148, 163, 184, .1);
            border-bottom: none;
            background: rgba(30, 41, 59, .4);
            color: #94a3b8;
            transition: all .2s;
            font-family: inherit;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 64px
        }

        .rmm-tab:hover {
            color: #c084fc;
            background: rgba(124, 58, 237, .08)
        }

        .rmm-tab.active {
            background: rgba(30, 41, 59, .8);
            color: #e2e8f0;
            border-color: rgba(168, 85, 247, .3);
            box-shadow: 0 -2px 8px rgba(124, 58, 237, .1)
        }

        .rmm-tab-icon {
            font-size: .95rem
        }

        .rmm-tab-label {
            font-size: .65rem
        }

        .rmm-tab-count {
            font-size: .55rem;
            color: #64748b;
            margin-top: 1px
        }

        .rmm-tab.active .rmm-tab-count {
            color: #a855f7
        }

        /* === ‰∏ªÈ´îÔºàÂõ∫ÂÆöÈ´òÂ∫¶ flex-growÔºâ=== */
        .rmm-body {
            display: flex;
            flex: 1;
            overflow: hidden;
            border-top: 1px solid rgba(148, 163, 184, .1);
            min-height: 0
        }

        .rmm-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0
        }

        .rmm-grid-wrap {
            flex: 1;
            overflow-y: auto;
            padding: 14px 10px 14px 20px;
            min-height: 0
        }

        .rmm-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            align-content: start
        }

        /* === Á®ÆÊóè Chip === */
        .rmm-race-chip {
            padding: 7px 9px;
            font-size: .73rem;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid rgba(148, 163, 184, .12);
            background: rgba(30, 41, 59, .5);
            color: #cbd5e1;
            transition: all .2s;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 5px;
            overflow: hidden;
            position: relative
        }

        .rmm-race-chip:hover {
            border-color: rgba(168, 85, 247, .4);
            color: #e2e8f0;
            background: rgba(124, 58, 237, .08);
            transform: translateY(-1px)
        }

        .rmm-race-chip.selected {
            background: rgba(124, 58, 237, .2);
            border-color: #a855f7;
            color: #fff;
            box-shadow: 0 0 10px rgba(168, 85, 247, .15)
        }

        .rmm-chip-icon {
            font-size: .85rem;
            flex-shrink: 0
        }

        .rmm-chip-text {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
            flex: 1
        }

        .rmm-chip-zh {
            font-size: .73rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .rmm-chip-en {
            font-size: .58rem;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .rmm-race-chip.selected .rmm-chip-en {
            color: rgba(255, 255, 255, .5)
        }

        /* === üî• ÁÜ±ÈñÄÊ®ôË®ò === */
        .rmm-hot-badge {
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: .55rem;
            color: #f59e0b;
            opacity: .7
        }

        .rmm-race-chip:hover .rmm-hot-badge {
            opacity: 1
        }

        /* === üìã ÊúÄËøë‰ΩøÁî®Ê®ôË®ò === */
        .rmm-recent-badge {
            position: absolute;
            bottom: 2px;
            right: 3px;
            font-size: .5rem;
            color: #38bdf8;
            opacity: .6
        }

        /* === A-Z Á¥¢Âºï === */
        .rmm-az {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px 6px;
            gap: 1px;
            border-left: 1px solid rgba(148, 163, 184, .08);
            user-select: none;
            flex-shrink: 0
        }

        .rmm-az-letter {
            font-size: .5rem;
            color: #475569;
            cursor: pointer;
            padding: 1px 4px;
            border-radius: 3px;
            transition: all .15s;
            line-height: 1.2
        }

        .rmm-az-letter:hover {
            color: #a855f7;
            background: rgba(168, 85, 247, .1)
        }

        .rmm-az-letter.active {
            color: #fff;
            background: rgba(124, 58, 237, .4)
        }

        /* === Âä†ÂàÜÁâπÂæµ === */
        .rmm-bonus {
            padding: 10px 24px;
            border-top: 1px solid rgba(148, 163, 184, .1);
            display: none;
            flex-shrink: 0
        }

        .rmm-bonus.show {
            display: block
        }

        .rmm-bonus-title {
            font-size: .75rem;
            color: #94a3b8;
            margin-bottom: 6px
        }

        .rmm-bonus-title span {
            color: #fbbf24
        }

        .rmm-bonus-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px
        }

        .rmm-bonus-tag {
            padding: 3px 10px;
            font-size: .7rem;
            border-radius: 16px;
            cursor: pointer;
            border: 1px solid rgba(148, 163, 184, .15);
            background: rgba(30, 41, 59, .5);
            color: #94a3b8;
            transition: all .2s;
            font-family: inherit
        }

        .rmm-bonus-tag:hover {
            border-color: rgba(251, 191, 36, .4);
            color: #fbbf24
        }

        .rmm-bonus-tag.active {
            background: rgba(251, 191, 36, .15);
            border-color: #fbbf24;
            color: #fbbf24
        }

        /* === Footer === */
        .rmm-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 24px;
            border-top: 1px solid rgba(148, 163, 184, .1);
            flex-shrink: 0
        }

        .rmm-status {
            font-size: .7rem;
            color: #64748b
        }

        .rmm-status b {
            color: #a855f7
        }

        .rmm-actions {
            display: flex;
            gap: 10px
        }

        .rmm-btn {
            padding: 7px 18px;
            border-radius: 8px;
            font-size: .78rem;
            cursor: pointer;
            font-family: inherit;
            border: none;
            transition: all .2s
        }

        .rmm-btn-cancel {
            background: rgba(100, 116, 139, .2);
            color: #94a3b8
        }

        .rmm-btn-cancel:hover {
            background: rgba(100, 116, 139, .3);
            color: #e2e8f0
        }

        .rmm-btn-apply {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: #fff;
            box-shadow: 0 3px 12px rgba(124, 58, 237, .3)
        }

        .rmm-btn-apply:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 16px rgba(124, 58, 237, .4)
        }

        .rmm-empty {
            grid-column: 1/-1;
            padding: 40px;
            text-align: center;
            color: #475569;
            font-size: .85rem
        }

        .rmm-grid-wrap::-webkit-scrollbar {
            width: 5px
        }

        .rmm-grid-wrap::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, .15);
            border-radius: 3px
        }

        /* === üé≤ Èö®Ê©üÈÅ∏ÂèñÂãïÁï´ === */
        @keyframes rmm-dice-spin {
            0% {
                transform: rotate(0deg)
            }

            100% {
                transform: rotate(720deg)
            }
        }

        .rmm-dice-spinning .rmm-tool-icon {
            animation: rmm-dice-spin .6s ease-out
        }

        /* === Èö®Ê©üÈÅ∏‰∏≠ÈñÉÂÖâ === */
        @keyframes rmm-chip-flash {
            0% {
                box-shadow: 0 0 0 rgba(251, 191, 36, 0)
            }

            30% {
                box-shadow: 0 0 20px rgba(251, 191, 36, .6)
            }

            100% {
                box-shadow: 0 0 10px rgba(168, 85, 247, .15)
            }
        }

        .rmm-race-chip.random-pick {
            animation: rmm-chip-flash .8s ease
        }
    </style>
</head>

<body>
    <button class="demo-trigger" id="open-modal">üîÆ ÈñãÂïüÈ´òÁ¥öÈ≠îÊ≥ï Modal</button>

    <!-- ÂºïÁî®ÂéüÂßã options-data.js ÂèñÂæóÂÆåÊï¥ RACES -->
    <script src="../data/options-data.js"></script>
    <script>
        // === Âæû PromptGen.Data ÂèñÂæóÂÆåÊï¥Á®ÆÊóèÂàóË°® ===
        const DATA = window.PromptGen && window.PromptGen.Data;
        const ORIGINAL_RACES = DATA ? DATA.RACES : [];

        // === üî• Top 20 ÁÜ±ÈñÄÁ®ÆÊóèÔºà‰æùÂ∏∏Áî®Â∫¶ÊéíÂ∫èÔºâ===
        const HOT_RACES = [
            'Human', 'Elf', 'Angel', 'Demon', 'Vampire', 'Succubus', 'Dragon', 'Cat Girl', 'Fox Girl',
            'Mermaid', 'Fairy', 'Bunny Girl', 'Dark Elf', 'Valkyrie', 'Kitsune',
            'Ghost', 'Android', 'Magical Girl', 'Wolf Girl', 'High Elf'
        ];

        // === üìã ÊúÄËøë‰ΩøÁî®ÔºàlocalStorageÔºâ===
        const RECENT_KEY = 'rmm_recent_races';
        function getRecentRaces() {
            try { return JSON.parse(localStorage.getItem(RECENT_KEY)) || []; } catch { return []; }
        }
        function addRecentRace(en) {
            let recent = getRecentRaces().filter(r => r !== en);
            recent.unshift(en);
            if (recent.length > 10) recent = recent.slice(0, 10);
            localStorage.setItem(RECENT_KEY, JSON.stringify(recent));
        }

        // === 10 Â§ßÂàÜÈ°û ===
        const RACE_CATEGORIES = [
            { id: 'all', label: 'ÂÖ®ÈÉ®', en: 'All', icon: 'üåê' },
            { id: 'recent', label: 'ÊúÄËøë', en: 'Recent', icon: 'üìã' },
            { id: 'hot', label: 'ÁÜ±ÈñÄ', en: 'Hot', icon: 'üî•' },
            { id: 'human', label: '‰∫∫È°û', en: 'Human', icon: 'üë§' },
            { id: 'elf', label: 'Á≤æÈùà', en: 'Elf', icon: 'üßù' },
            { id: 'beast', label: 'Áç∏‰∫∫', en: 'Beast', icon: 'üêæ' },
            { id: 'mecha', label: 'Ê©üÊ¢∞', en: 'Mech', icon: '‚öôÔ∏è' },
            { id: 'myth', label: 'Á•ûË©±', en: 'Myth', icon: 'üèõÔ∏è' },
            { id: 'undead', label: '‰∫°Èùà', en: 'Undead', icon: 'üëª' },
            { id: 'yokai', label: 'Â¶ñÊÄ™', en: 'Yokai', icon: 'üéå' },
            { id: 'other', label: 'Áï∞Áïå', en: 'Other', icon: 'üåÄ' },
            { id: 'fantasy', label: 'ÂπªÊÉ≥', en: 'Fantasy', icon: '‚ú®' }
        ];

        // === Ëá™ÂãïÂàÜÈ°ûÊò†Â∞Ñ ===
        const CATEGORY_MAP = {
            human: ['Human', 'Werewolf', 'Bunny Girl', 'Magical Girl',
                'Onmyoji Spirit', 'Shield Maiden', 'Heroic Spirit', 'Valkyrie', 'Demigod',
                'Barrier Mage', 'Xian'],
            elf: ['Elf', 'High Elf', 'Dark Elf', 'Wood Elf', 'Moon Elf', 'Sea Elf', 'Blood Elf', 'Sun Elf',
                'Fairy', 'Half-Elf', 'Elf King', 'Light Elf', 'Dark Elf (Norse)',
                'Fire Spirit', 'Water Spirit', 'Wind Spirit', 'Earth Spirit', 'Thunder Spirit',
                'Ice Spirit', 'Light Spirit', 'Dark Spirit', 'Flower Spirit', 'Star Spirit',
                'Nymph', 'Sylph', 'Time Spirit'],
            beast: ['Cat Girl', 'Fox Girl', 'Dog Girl', 'Wolf Girl', 'Tiger Girl', 'Horse Girl',
                'Snake Girl', 'Spider Girl', 'Harpy', 'Bat Girl', 'Mouse Girl', 'Sheep Girl',
                'Shark Girl', 'Deer Girl', 'Bear Girl', 'Lion Girl', 'Squirrel Girl',
                'Peacock Girl', 'Crane Girl', 'Lizard Girl', 'Octopus Girl', 'Bee Girl',
                'Kemonomimi', 'Kitsune', 'Scorpion Girl', 'Swallow Girl', 'Firefly Spirit',
                'Swan Girl', 'Butterfly Spirit', 'Seahorse Girl', 'Pearl Spirit',
                'Thunderbird', 'Garuda', 'Salamander', "Will-o'-Wisp",
                'Beastkin', 'Half-Yokai'],
            mecha: ['Android', 'Cyborg', 'Mecha Angel', 'Homunculus', 'Virtual Idol',
                'Nano Being', 'Space Elf', 'Armor Spirit'],
            myth: ['Angel', 'Demon', 'Succubus', 'Dragon', 'Mermaid', 'Fallen Angel',
                'Centaur', 'Medusa', 'Phoenix', 'Unicorn', 'Siren', 'Pegasus', 'Griffin Rider',
                'Sphinx', 'Minotaur', 'Hydra', 'Chimera', 'Cerberus', 'Satyr', 'Giant',
                'Tennin', 'White Serpent', "Chang'e", 'Dragon Palace Princess', 'Weaver Girl',
                'Raiju', 'Qilin', 'Vermillion Bird', 'Black Tortoise', 'Azure Dragon', 'White Tiger',
                'Norse Dwarf', 'Frost Giant', 'Fire Giant', 'World Serpent'],
            undead: ['Vampire', 'Vampire Noble', 'Zombie', 'Ghost', 'Skeleton', 'Lich',
                'Grim Reaper', 'Mummy', 'Wraith', 'Ghoul', 'Death Knight', 'Dracolich'],
            yokai: ['Oni', 'Tengu', 'Kappa', 'Yuki-onna', 'Bakeneko', 'Zashiki-warashi', 'Hannya',
                'Jorogumo', 'Kamaitachi', 'Tsukumogami', 'Nue', 'Tamamo-no-Mae',
                'Hyakki Yagyo', 'Lady Fox Spirit'],
            other: ['Alien', 'Slime',
                'Golem', 'Shadow Person', 'Crystal Being', 'Multi-limbed', 'Parasite Host', 'Mirror Being',
                'Dwarf', 'Orc', 'Goblin', 'Troll', 'Gargoyle', 'Ogre', 'Lamia', 'Gnome',
                'Night Hag', 'Thri-kreen', 'Shapeshifter'],
            fantasy: ['Dragon Princess', 'Elder Dragon', 'Ice Dragon', 'Fire Dragon', 'Eastern Dragon',
                'Crystal Dragon', 'Shadow Dragon', 'Wyvern',
                'Arch Demon', 'Nightmare', 'Imp', 'Yaksha', 'Rakshasa', 'Asura', 'Demon Lord',
                'Deity', 'Spirit', 'Celestial', 'Kami',
                'Flower Yokai', 'Mushroom Girl', 'Mandragora', 'Treant', 'Vine Spirit', 'Alraune',
                'Sea Dragon', 'Undine', 'Jellyfish Girl', 'Kraken Girl', 'Coral Spirit', 'Deep One',
                'Titan', 'Dream Being', 'Astral Being', 'Void Being',
                'Nightmare Avatar', 'Fate Goddess', 'Chaos Beast', 'Order Angel', 'Nature Avatar', 'Star Messenger',
                'Shikigami', 'Living Doll', 'Familiar', 'Weapon Spirit',
                'Half-Dragon', 'Nephilim', 'Tiefling', 'Will-o-Wisp']
        };

        function autoClassify(en) {
            for (const [cat, names] of Object.entries(CATEGORY_MAP)) {
                if (names.includes(en)) return cat;
            }
            return 'other';
        }

        // === Icon Êò†Â∞Ñ ===
        const ICON_MAP = [
            [/human/i, 'üë§'], [/elf/i, 'üßù'], [/angel/i, 'üòá'], [/demon|succubus|imp|asura|rakshasa|yaksha/i, 'üòà'],
            [/vampire/i, 'üßõ'], [/dragon|wyvern|dracolich/i, 'üêâ'], [/fairy/i, 'üßö'], [/mermaid|undine|sea/i, 'üßú'],
            [/ghost|wraith|spirit/i, 'üëª'], [/android|cyborg|mecha|nano|virtual/i, 'ü§ñ'],
            [/cat/i, 'üê±'], [/fox|kitsune|tamamo/i, 'ü¶ä'], [/dog/i, 'üêï'], [/wolf|were/i, 'üê∫'],
            [/tiger|byakko/i, 'üêØ'], [/horse|centaur|pegasus/i, 'üê¥'], [/snake|serpent|lamia|medusa/i, 'üêç'],
            [/spider|jorogumo|arachne/i, 'üï∑Ô∏è'], [/bird|harpy|crane|swan|swallow|garuda|thunder/i, 'ü¶Ö'],
            [/bat/i, 'ü¶á'], [/mouse/i, 'üê≠'], [/sheep/i, 'üêë'], [/shark/i, 'ü¶à'], [/deer|qilin/i, 'ü¶å'],
            [/bear/i, 'üêª'], [/lion|sphinx/i, 'ü¶Å'], [/squirrel/i, 'üêøÔ∏è'], [/peacock/i, 'ü¶ö'],
            [/lizard|salamander/i, 'ü¶é'], [/octopus|kraken/i, 'üêô'], [/bee/i, 'üêù'], [/scorpion/i, 'ü¶Ç'],
            [/butterfly/i, 'ü¶ã'], [/firefly|wisp/i, '‚ú®'], [/oni|hannya|ogre|goblin|troll/i, 'üëπ'],
            [/tengu/i, 'üë∫'], [/kappa/i, 'üê∏'], [/zombie|skeleton|ghoul|mummy/i, 'üíÄ'],
            [/lich|reaper|death/i, '‚ö∞Ô∏è'], [/alien/i, 'üëΩ'], [/slime/i, 'ü´ß'], [/golem/i, 'üóø'],
            [/crystal|pearl/i, 'üíé'], [/dwarf|gnome|norse dwarf/i, '‚õèÔ∏è'], [/orc/i, 'üëπ'],
            [/phoenix|vermillion/i, 'üî•'], [/unicorn/i, 'ü¶Ñ'], [/titan|giant|frost giant|fire giant/i, 'üóª'],
            [/magical girl/i, 'üíñ'], [/bunny/i, 'üê∞'], [/doll/i, 'üéé'], [/shikigami/i, 'üìú'],
            [/weapon/i, 'üó°Ô∏è'], [/armor/i, 'üõ°Ô∏è'], [/valkyrie|shield/i, '‚öîÔ∏è'],
            [/yuki|ice|frost/i, '‚ùÑÔ∏è'], [/moon|chang/i, 'üåô'], [/sun/i, '‚òÄÔ∏è'], [/star|astral|cosmic/i, '‚≠ê'],
            [/fire/i, 'üî•'], [/water|aqua/i, 'üíß'], [/wind|air|sylph/i, 'üå¨Ô∏è'], [/earth|stone/i, 'ü™®'],
            [/thunder|lightning|raiju/i, '‚ö°'], [/light|radiant/i, 'üí°'], [/dark|shadow|void|night/i, 'üåë'],
            [/flower|alraune|bloom/i, 'üå∏'], [/mushroom/i, 'üçÑ'], [/tree|mandragora|vine/i, 'üåø'],
            [/chaos/i, 'üå™Ô∏è'], [/fate|destiny/i, 'üîÆ'], [/dream|nightmare/i, 'üí≠'],
            [/time|chrono/i, '‚è≥'], [/nature|gaia/i, 'üåç'], [/coral|jellyfish/i, 'üåä'],
            [/tortoise|genbu/i, 'üê¢'], [/order/i, '‚ú®'], [/heroic/i, '‚öîÔ∏è'],
            [/gargoyle/i, 'üóø'], [/shapeshifter/i, 'üîÑ'], [/mirror/i, 'ü™û'],
            [/parasite/i, 'üß¨'], [/multi/i, 'ü¶ë'], [/familiar/i, 'üêà'],
            [/onmyoji|kami/i, '‚òØÔ∏è'], [/xian|celestial/i, 'üèîÔ∏è'], [/deity/i, 'üëë'],
            [/weaver/i, 'üßµ'], [/palace/i, 'üë∏'], [/nymph/i, 'üåø'], [/siren/i, 'üéµ'],
            [/griffin/i, 'ü¶Ö'], [/chimera|nue/i, 'üê≤'], [/cerberus/i, 'üêï'], [/hydra|world serpent/i, 'üêç'],
            [/minotaur|satyr/i, 'üêÇ'], [/seahorse/i, 'üê¥'], [/space/i, 'üöÄ'],
            [/zashiki|tsukumogami/i, 'üëò'], [/hyakki|parade/i, 'üé≠'], [/kamaitachi/i, 'üå™Ô∏è'],
            [/bakeneko/i, 'üê±']
        ];
        function getIcon(en) {
            for (const [re, icon] of ICON_MAP) { if (re.test(en)) return icon; }
            return 'üîπ';
        }

        // === Âª∫ÊßãÂÆåÊï¥Á®ÆÊóèÂàóË°® ===
        const RACES = ORIGINAL_RACES.map(r => ({
            ...r,
            cat: autoClassify(r.en),
            icon: getIcon(r.en),
            isHot: HOT_RACES.includes(r.en)
        }));

        // === Âä†ÂàÜÁâπÂæµ ===
        const BONUS_TRAITS = {
            human: ['pale skin', 'red eyes', 'fangs', 'transformation', 'divine aura', 'warrior armor', 'mystical robes'],
            elf: ['pointed ears', 'elegant', 'ancient', 'magical aura', 'nature', 'glowing eyes', 'long hair', 'ethereal'],
            beast: ['animal ears', 'tail', 'fur', 'fangs', 'claws', 'whiskers', 'fluffy', 'feral eyes'],
            mecha: ['mechanical parts', 'glowing circuits', 'metal skin', 'laser eyes', 'holographic', 'neon glow'],
            myth: ['wings', 'halo', 'horns', 'divine light', 'scales', 'trident', 'crown', 'sacred flame'],
            undead: ['pale skin', 'hollow eyes', 'skeletal', 'ghostly glow', 'dark aura', 'chains', 'tattered cloak', 'blood'],
            yokai: ['oni horns', 'fox mask', 'spiritual fire', 'kimono', 'paper talismans', 'ethereal mist', 'red markings'],
            other: ['supernatural aura', 'crystalline', 'alien features', 'dark magic', 'glowing', 'translucent', 'shapeshifting'],
            fantasy: ['dragon horns', 'dragon wings', 'dragon tail', 'scales', 'crown', 'massive', 'cosmic', 'primordial aura']
        };

        // === Modal State ===
        let selectedRace = null;
        let selectedBonuses = new Set();
        let activeCat = 'all';
        let searchQuery = '';
        let filterLetter = null;

        function openRaceMagicModal() {
            const existing = document.getElementById('race-magic-modal');
            if (existing) existing.remove();
            selectedBonuses.clear();
            filterLetter = null;
            activeCat = 'all';
            searchQuery = '';

            const overlay = document.createElement('div');
            overlay.id = 'race-magic-modal';
            overlay.innerHTML = `
    <div class="rmm-flash"></div>
    <div class="rmm-magic-circle">
      <svg viewBox="0 0 200 200"><circle cx="100" cy="100" r="90" fill="none" stroke="#a855f7" stroke-width=".5"/>
      <circle cx="100" cy="100" r="70" fill="none" stroke="#7c3aed" stroke-width=".3"/>
      <circle cx="100" cy="100" r="50" fill="none" stroke="#c084fc" stroke-width=".3"/>
      <polygon points="100,15 178,145 22,145" fill="none" stroke="#a855f7" stroke-width=".4"/>
      <polygon points="100,185 22,55 178,55" fill="none" stroke="#7c3aed" stroke-width=".4"/>
      <text x="100" y="105" text-anchor="middle" fill="#a855f7" font-size="8" opacity=".4">‚ú¶ MAGIC ‚ú¶</text></svg>
    </div>
    <div class="rmm-particles" id="rmm-particles"></div>
    <div class="rmm-container">
      <div class="rmm-header">
        <div class="rmm-title-row">
          <div class="rmm-title">üîÆ È´òÁ¥öÈ≠îÊ≥ï„ÉªÁ®ÆÊóèÂ§ßÂÖ®</div>
          <div class="rmm-toolbar">
            <button class="rmm-tool-btn" id="rmm-dice" title="Èö®Ê©üÈÅ∏Âèñ"><span class="rmm-tool-icon">üé≤</span> Èö®Ê©ü</button>
          </div>
        </div>
        <div class="rmm-search-row">
          <div class="rmm-search-wrap">
            <i class="fa-solid fa-magnifying-glass rmm-search-icon"></i>
            <input type="text" class="rmm-search" id="rmm-search" placeholder="ÊêúÂ∞ãÁ®ÆÊóè Search race...">
          </div>
        </div>
      </div>
      <div class="rmm-tabs" id="rmm-tabs"></div>
      <div class="rmm-body">
        <div class="rmm-main">
          <div class="rmm-grid-wrap" id="rmm-grid-wrap"><div class="rmm-grid" id="rmm-grid"></div></div>
        </div>
        <div class="rmm-az" id="rmm-az"></div>
      </div>
      <div class="rmm-bonus" id="rmm-bonus">
        <div class="rmm-bonus-title">‚≠ê Âä†ÂàÜÁâπÂæµ ‚Äî <span id="rmm-bonus-race"></span></div>
        <div class="rmm-bonus-tags" id="rmm-bonus-tags"></div>
      </div>
      <div class="rmm-footer">
        <div class="rmm-status" id="rmm-status"></div>
        <div class="rmm-actions">
          <button class="rmm-btn rmm-btn-cancel" id="rmm-cancel">‚ùå ÂèñÊ∂à</button>
          <button class="rmm-btn rmm-btn-apply" id="rmm-apply">‚ú® Â•óÁî®</button>
        </div>
      </div>
    </div>
  `;
            document.body.appendChild(overlay);

            // === Particles ===
            const pc = document.getElementById('rmm-particles');
            const colors = ['#fbbf24', '#a855f7', '#7c3aed', '#f59e0b', '#c084fc', '#fff', '#e879f9'];
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.className = 'rmm-particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDelay = Math.random() * 4 + 's';
                p.style.animationDuration = (3 + Math.random() * 4) + 's';
                p.style.background = colors[Math.floor(Math.random() * colors.length)];
                const s = 2 + Math.random() * 4;
                p.style.width = p.style.height = s + 'px';
                p.style.boxShadow = `0 0 ${s * 2}px ${p.style.background}`;
                pc.appendChild(p);
            }

            // === Meteors ===
            for (let i = 0; i < 4; i++) {
                const m = document.createElement('div');
                m.className = 'rmm-meteor';
                m.style.top = (Math.random() * 30) + '%';
                m.style.left = (50 + Math.random() * 50) + '%';
                m.style.animationDelay = (0.5 + Math.random() * 3) + 's';
                m.style.animationDuration = (1 + Math.random() * 1.5) + 's';
                overlay.appendChild(m);
            }

            playOpenSound();

            // === TabsÔºàÂê´ Recent Âíå HotÔºâ===
            const tabsEl = document.getElementById('rmm-tabs');
            RACE_CATEGORIES.forEach(c => {
                let count;
                if (c.id === 'all') count = RACES.length;
                else if (c.id === 'hot') count = HOT_RACES.length;
                else if (c.id === 'recent') count = getRecentRaces().length;
                else count = RACES.filter(r => r.cat === c.id).length;

                const tab = document.createElement('div');
                tab.className = 'rmm-tab' + (c.id === activeCat ? ' active' : '');
                tab.dataset.cat = c.id;
                tab.innerHTML = `<span class="rmm-tab-icon">${c.icon}</span><span class="rmm-tab-label">${c.label}<br>${c.en}</span><span class="rmm-tab-count">${count}</span>`;
                tab.addEventListener('click', () => {
                    activeCat = c.id;
                    filterLetter = null;
                    document.getElementById('rmm-az').querySelectorAll('.rmm-az-letter').forEach(l => l.classList.remove('active'));
                    tabsEl.querySelectorAll('.rmm-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderGrid();
                });
                tabsEl.appendChild(tab);
            });

            // === A-Z ===
            const azEl = document.getElementById('rmm-az');
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter => {
                const el = document.createElement('div');
                el.className = 'rmm-az-letter';
                el.textContent = letter;
                el.addEventListener('click', () => {
                    filterLetter = letter;
                    searchQuery = '';
                    document.getElementById('rmm-search').value = '';
                    activeCat = 'all';
                    tabsEl.querySelectorAll('.rmm-tab').forEach(t => t.classList.remove('active'));
                    tabsEl.querySelector('.rmm-tab').classList.add('active');
                    azEl.querySelectorAll('.rmm-az-letter').forEach(l => l.classList.remove('active'));
                    el.classList.add('active');
                    renderGrid();
                });
                azEl.appendChild(el);
            });

            // === Search ===
            document.getElementById('rmm-search').addEventListener('input', e => {
                searchQuery = e.target.value.toLowerCase();
                filterLetter = null;
                azEl.querySelectorAll('.rmm-az-letter').forEach(l => l.classList.remove('active'));
                renderGrid();
            });

            // === üé≤ Èö®Ê©üÈÅ∏Âèñ ===
            document.getElementById('rmm-dice').addEventListener('click', function () {
                this.classList.add('rmm-dice-spinning');
                setTimeout(() => this.classList.remove('rmm-dice-spinning'), 600);
                // ÂèñÂæóÁõÆÂâçÂèØË¶ãÁöÑÁ®ÆÊóè
                const currentFiltered = getFilteredRaces();
                if (!currentFiltered.length) return;
                const randomRace = currentFiltered[Math.floor(Math.random() * currentFiltered.length)];
                selectedRace = randomRace;
                selectedBonuses.clear();
                playSelectSound();
                renderGrid();
                renderBonus(randomRace);
                // ÊªæÂãïÂà∞ÈÅ∏‰∏≠ÁöÑ chip
                setTimeout(() => {
                    const selectedEl = document.querySelector('.rmm-race-chip.selected');
                    if (selectedEl) {
                        selectedEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        selectedEl.classList.add('random-pick');
                    }
                }, 50);
            });

            renderGrid();

            // === Close ===
            function closeModal() {
                overlay.style.animation = 'rmm-fadeIn .3s ease reverse';
                setTimeout(() => overlay.remove(), 280);
            }
            document.getElementById('rmm-cancel').addEventListener('click', closeModal);
            document.getElementById('rmm-apply').addEventListener('click', () => {
                if (selectedRace) {
                    addRecentRace(selectedRace.en);
                    // Êõ¥Êñ∞ Recent tab Ë®àÊï∏
                    const recentTab = tabsEl.querySelector('[data-cat="recent"]');
                    if (recentTab) {
                        recentTab.querySelector('.rmm-tab-count').textContent = getRecentRaces().length;
                    }
                    const bonusArr = [...selectedBonuses];
                    const bonusStr = bonusArr.length ? '\nÂä†ÂàÜÁâπÂæµ: ' + bonusArr.join(', ') : '';
                    alert('‚ú® Â∑≤ÈÅ∏Êìá: ' + selectedRace.label + ' (' + selectedRace.en + ')\nPrompt: ' + selectedRace.value + bonusStr);
                }
                closeModal();
            });
            overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });
            const escH = e => { if (e.key === 'Escape') { closeModal(); document.removeEventListener('keydown', escH); } };
            document.addEventListener('keydown', escH);
        }

        // === ÂèñÂæóÁØ©ÈÅ∏ÂæåÁöÑÁ®ÆÊóè ===
        function getFilteredRaces() {
            let filtered = RACES;
            const recent = getRecentRaces();

            if (activeCat === 'recent') {
                // Âè™È°ØÁ§∫ÊúÄËøëÁî®ÈÅéÁöÑÔºåÊåâ‰ΩøÁî®È†ÜÂ∫èÊéí
                filtered = recent.map(en => RACES.find(r => r.en === en)).filter(Boolean);
            } else if (activeCat === 'hot') {
                filtered = RACES.filter(r => r.isHot);
            } else if (activeCat !== 'all') {
                filtered = filtered.filter(r => r.cat === activeCat);
            }

            if (searchQuery) {
                filtered = filtered.filter(r =>
                    r.label.includes(searchQuery) || r.en.toLowerCase().includes(searchQuery) || r.value.toLowerCase().includes(searchQuery)
                );
            }
            if (filterLetter) {
                filtered = filtered.filter(r => r.en.charAt(0).toUpperCase() === filterLetter);
            }
            return filtered;
        }

        function renderGrid() {
            const grid = document.getElementById('rmm-grid');
            const filtered = getFilteredRaces();
            const recent = getRecentRaces();
            const total = RACES.length;
            const shown = filtered.length;
            const selText = selectedRace ? ` | Â∑≤ÈÅ∏Ôºö<b>${selectedRace.label}</b>` : '';
            document.getElementById('rmm-status').innerHTML = `Â∑≤ËºâÂÖ• ${total} Á®ÆÊóè | È°ØÁ§∫ ${shown}/${total}${selText}`;

            grid.innerHTML = '';
            if (!filtered.length) {
                grid.innerHTML = '<div class="rmm-empty">üîç Êâæ‰∏çÂà∞Á¨¶ÂêàÁöÑÁ®ÆÊóè</div>';
                return;
            }
            filtered.forEach(race => {
                const chip = document.createElement('div');
                const isSelected = selectedRace && selectedRace.value === race.value;
                chip.className = 'rmm-race-chip' + (isSelected ? ' selected' : '');

                // üî• ÁÜ±ÈñÄÊ®ôË®ò + üìã ÊúÄËøë‰ΩøÁî®Ê®ôË®ò
                const hotBadge = race.isHot ? '<span class="rmm-hot-badge">üî•</span>' : '';
                const recentBadge = recent.includes(race.en) && activeCat !== 'recent' ? '<span class="rmm-recent-badge">üìã</span>' : '';

                chip.innerHTML = `<span class="rmm-chip-icon">${race.icon}</span><span class="rmm-chip-text"><span class="rmm-chip-zh">${race.label}</span><span class="rmm-chip-en">${race.en}</span></span>${hotBadge}${recentBadge}`;
                chip.addEventListener('click', () => {
                    if (selectedRace && selectedRace.value === race.value) {
                        // ÂÜçÈªû‰∏ÄÊ¨°ÂèñÊ∂àÈÅ∏Âèñ
                        selectedRace = null;
                        selectedBonuses.clear();
                        document.getElementById('rmm-bonus').classList.remove('show');
                    } else {
                        selectedRace = race;
                        selectedBonuses.clear();
                        playSelectSound();
                        renderBonus(race);
                    }
                    renderGrid();
                });
                grid.appendChild(chip);
            });

            // Á¢∫‰øùÊªæÂãïÂõûÈ†ÇÈÉ®
            document.getElementById('rmm-grid-wrap').scrollTop = 0;
        }

        function renderBonus(race) {
            const panel = document.getElementById('rmm-bonus');
            const tagsEl = document.getElementById('rmm-bonus-tags');
            const nameEl = document.getElementById('rmm-bonus-race');
            const traits = BONUS_TRAITS[race.cat] || [];
            if (!traits.length) { panel.classList.remove('show'); return; }
            nameEl.textContent = race.label + ' ' + race.en;
            tagsEl.innerHTML = '';
            traits.forEach(trait => {
                const tag = document.createElement('button');
                tag.className = 'rmm-bonus-tag' + (selectedBonuses.has(trait) ? ' active' : '');
                tag.textContent = trait;
                tag.addEventListener('click', () => {
                    if (selectedBonuses.has(trait)) selectedBonuses.delete(trait);
                    else selectedBonuses.add(trait);
                    tag.classList.toggle('active');
                });
                tagsEl.appendChild(tag);
            });
            panel.classList.add('show');
        }

        // === Èü≥Êïà ===
        function playOpenSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const now = ctx.currentTime;
                const drone = ctx.createOscillator();
                const droneG = ctx.createGain();
                drone.connect(droneG); droneG.connect(ctx.destination);
                drone.type = 'sine';
                drone.frequency.setValueAtTime(100, now);
                drone.frequency.exponentialRampToValueAtTime(200, now + 0.5);
                droneG.gain.setValueAtTime(0, now);
                droneG.gain.linearRampToValueAtTime(0.05, now + 0.15);
                droneG.gain.exponentialRampToValueAtTime(0.001, now + 0.8);
                drone.start(now); drone.stop(now + 0.8);
                [523.25, 587.33, 659.25, 698.46, 783.99, 880, 987.77, 1046.5].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.connect(g); g.connect(ctx.destination);
                    osc.type = 'triangle'; osc.frequency.value = freq;
                    const t = now + 0.1 + i * 0.07;
                    g.gain.setValueAtTime(0, t);
                    g.gain.linearRampToValueAtTime(0.04, t + 0.02);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
                    osc.start(t); osc.stop(t + 0.3);
                });
                [1318.51, 1567.98, 2093].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.connect(g); g.connect(ctx.destination);
                    osc.type = 'sine'; osc.frequency.value = freq;
                    const t = now + 0.7 + i * 0.03;
                    g.gain.setValueAtTime(0, t);
                    g.gain.linearRampToValueAtTime(0.025, t + 0.02);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                    osc.start(t); osc.stop(t + 0.5);
                });
            } catch (e) { console.warn('Sound error:', e); }
        }

        function playSelectSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const now = ctx.currentTime;
                [1200, 1800, 2400].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.connect(g); g.connect(ctx.destination);
                    osc.type = 'sine'; osc.frequency.value = freq;
                    const t = now + i * 0.04;
                    g.gain.setValueAtTime(0.035, t);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
                    osc.start(t); osc.stop(t + 0.2);
                });
            } catch (e) { }
        }

        document.getElementById('open-modal').addEventListener('click', openRaceMagicModal);
    </script>
</body>

</html>